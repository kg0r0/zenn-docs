---
title: "Keycloak ã§è©¦ã™ WebAuthentication (WebAuthn) x OpenID Connect (OIDC)"
emoji: "ğŸ”‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["oidc", "fido", "keycloak"]
published: true
---

Digital Identity æŠ€è¡“å‹‰å¼·ä¼š #iddance Advent Calendar 2023 8 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

https://qiita.com/advent-calendar/2023/iddance

æœ¬æŠ•ç¨¿ã§ã¯ã€OpenID Connect (OIDC)[^1] ã¨ Web Authentication (WebAuthn)[^2] ã®é–¢é€£æ€§ã«è§¦ã‚Œã¤ã¤ã€Keycloak ã‚’ Identity Provider (IdP) ã¨ã—ã¦ä½¿ç”¨ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ãªèªè¨¼ã‚’å°å…¥ã™ã‚‹è€ƒãˆæ–¹ã«ã¤ã„ã¦è¨˜è¼‰ã—ã¾ã™ã€‚
ä»¥ä¸‹ã®è¨˜äº‹ã§ WebAuthn RP ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚„ Passkeys ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹æ–¹æ³•ã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ãŒã€è‡ªã‚‰ WebAuthn RP ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãªã WebAuthn ã‚’ä½¿ç”¨ã—ãŸèªè¨¼ã‚’å°å…¥ã™ã‚‹æ–¹æ³•ãŒã‚ã‚‹ã“ã¨ã‚’ç´¹ä»‹ã§ãã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

https://zenn.dev/kg0r0/articles/c271abb1ab2b76

ãªãŠã€æœ¬æŠ•ç¨¿ã§ã¯èª¬æ˜ã®éƒ½åˆä¸Š WebAuthn ãŠã‚ˆã³ FIDO2 ã¨ã„ã†ç”¨èªãŒç™»å ´ã—ã¾ã™ãŒã€WebAuthn ã¯ FIDO2 ä»•æ§˜ã®ä¸€éƒ¨ã§ã‚ã‚Šã€æœ¬æŠ•ç¨¿ã«ãŠã„ã¦ã¯åŸºæœ¬çš„ã«åŒã˜ç”¨èªã‚’æŒ‡ã—ã¦ã„ã‚‹ã‚‚ã®ã¨è€ƒãˆã¦ã„ãŸã ã„ã¦å•é¡Œã‚ã‚Šã¾ã›ã‚“[^3]ã€‚

> Web Authentication (WebAuthn), a core component of FIDO Allianceâ€™s FIDO2 set of specifications, is a web-based API that allows websites to update their login pages to add FIDO-based authentication on supported browsers and platforms. 
> (å¼•ç”¨å…ƒ: https://fidoalliance.org/fido2-2/fido2-web-authentication-webauthn/)

# ã¯ã˜ã‚ã«

ã¾ãšã€OIDC (ã‚„ SAML) ã¯ ID é€£æºã®ä»•æ§˜ã§ã‚ã‚Šã€FIDO ã¨ã®é–¢é€£æ€§ã¯ä»¥ä¸‹ã®é€šã‚Šè£œå®Œé–¢ä¿‚ã¨ãªã‚Šã¾ã™[^4]ã€‚

> FIDO and federation protocols are not only complementary but function optimally together.
> (å¼•ç”¨å…ƒ: https://fidoalliance.org/fido-and-federation-protocols-tech-note/)

OIDC ã¨ FIDO ã®é–¢é€£æ€§ã‚’å›³ç¤ºã™ã‚‹ã¨ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![Initial â€˜Sign-inâ€™ with FIDO-based Authentication](/images/972c915c55327f/FIDO_Federation_Figure_1.png)
*Initial â€˜Sign-inâ€™ with FIDO-based Authentication[^4]*

OIDC OP ã¯ OIDC ã®ãƒ•ãƒ­ãƒ¼ã«ãŠã‘ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã«ãŠã„ã¦ WebAuthn ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã€OIDC RP ã¯ OIDC OP ãŒç™ºè¡Œã™ã‚‹ ID Token ã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼çµæœã‚„å±æ€§æƒ…å ±ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€OIDC OP ãŒ WebAuthn RP ã¨ã—ã¦å‹•ä½œã™ã‚‹å ´åˆã€OIDC RP è‡ªèº«ãŒ WebAuthn RP ã¨ã—ã¦å‹•ä½œã—ãªã„å ´åˆã‚‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ãªèªè¨¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

æœ¬æŠ•ç¨¿ã§ã¯ã€OIDC OP ãŠã‚ˆã³ WebAuthn RP ã®æ©Ÿèƒ½ã‚’æœ‰ã—ã¦ã„ã‚‹ Keycloak ã‚’ä½¿ç”¨ã—ã¦å‰è¿°ã®å‹•ä½œã‚’å®Ÿéš›ã«è©¦ã—ã¦ã¿ã¾ã™ã€‚
Keycloak ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ[^5]ã«è¨˜è¼‰ã®é€šã‚Šã€Keycloak ã¯ WebAuthn RP ã¨ã—ã¦å‹•ä½œã— Passkeys ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

> Passkeys
> Keycloak provides preview support for Passkeys. Keycloak works as a Passkeys Relying Party (RP).
> Passkey registration and authentication are realized by the features of WebAuthn. Therefore, users of Keycloak can do passkey registration and authentication by existing WebAuthn registraton and authentication.
> (å¼•ç”¨å…ƒ: https://www.keycloak.org/docs/latest/server_admin/#passkeys_server_administration_guide)

ãªãŠã€å‹•ä½œç¢ºèªã§ã¯ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã®å®Ÿè£…ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
åŸºæœ¬çš„ãªè¨­å®šãŒãŠã“ãªã‚ã‚ŒãŸçŠ¶æ…‹ã§èµ·å‹•ã™ã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ã‚‹ãŸã‚ä¸æ˜ç‚¹ãªã©ãŒã‚ã‚Œã°å¿…è¦ã«å¿œã˜ã¦ã”ç¢ºèªãã ã•ã„ã€‚

https://github.com/kg0r0/keycloak-oidc-rp


# è¨­å®š

Keycloak ã«ã¦ OIDC RP ã®ä½œæˆã¨ WebAuthn ã®è¨­å®šã‚’ãã‚Œãã‚Œè¡Œã„ã¾ã™ã€‚

## OIDC

ã¾ãšã¯ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ‰‹é †ã«å¾“ã£ã¦ OIDC RP ã‚’ä½œæˆã—ã¾ã™ã€‚

https://www.keycloak.org/docs/latest/server_admin/#assembly-managing-clients_server_administration_guide

è¨­å®šå€¤ã«ã¤ã„ã¦ã¯ã€å®Ÿéš›ã® OIDC RP ã®è¦ä»¶ã«ã‚‚ã¨ã¥ã„ã¦é©åˆ‡ãªå€¤ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚å‹•ä½œç¢ºèªã§ä½¿ç”¨ã™ã‚‹ OIDC RP ã«ã¤ã„ã¦ã¯ã€localhost ã§å‹•ä½œã™ã‚‹ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹ãŸã‚ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã«ã—ã¦ã„ã¾ã™ã€‚

![Clients](/images/972c915c55327f/oidc-rp-settings.png)

## WebAuthn

æ¬¡ã«ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã€WebAuthn ã«é–¢ã™ã‚‹è¨­å®šã‚’ãŠã“ãªã£ã¦ã„ãã¾ã™ã€‚

 https://www.keycloak.org/docs/latest/server_admin/#webauthn_server_administration_guide

ç‰¹ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ãªèªè¨¼ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã® "Passwordless WebAuthn together with Two-Factor" ã‚„ "LoginLess WebAuthn" ã®æ‰‹é †ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚

- **Passwordless WebAuthn together with Two-Factor:** https://www.keycloak.org/docs/latest/server_admin/#_webauthn_passwordless
- **LoginLess WebAuthn:** https://www.keycloak.org/docs/latest/server_admin/#_webauthn_loginless

ãªãŠã€ä¸Šè¨˜ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã®æ‰‹é †ã«ã‚ˆã‚‹è¨­å®šã¯å€‹äººçš„ã«æ„å›³ã—ã¦ã„ãŸèªè¨¼ãƒ•ãƒ­ãƒ¼ã§ã¯ãªã‹ã£ãŸãŸã‚ã€ä»Šå›ã¯ä»¥ä¸‹ã®ãƒ–ãƒ­ã‚°[^6]ã«è¨˜è¼‰ã®è¨­å®šã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚

https://refactorfirst.com/setup-fido2-passwordless-authentication-with-keycloak

Authentication flow ã®è¨­å®šã¨ã—ã¦ã¯ã€``Username Form`` ã¨ ``WebAuthn Passwordless Authenticator`` ã‚’ãã‚Œãã‚Œ Required ã¨ã—ã¦ã„ã¾ã™ã€‚

![](/images/972c915c55327f/authentication_flows.png)

ä¸Šè¨˜ã® Authentication flow ã‚’ Browser flow ã«ãƒã‚¤ãƒ³ãƒ‰ã—ã¦ã„ã¾ã™ã€‚

![](/images/972c915c55327f/fido2_flow.png)

ä»Šå›ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã«ç™»éŒ²ã‚’è¡Œã‚ã›ãŸã„ãŸã‚ ``User registration`` ã‚’ On ã«ã—ã¦ãŠãã¾ã™ã€‚

![](/images/972c915c55327f/user_registration.png)

ã¾ãŸã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ™‚ã«èªè¨¼å™¨ã®è¨­å®šã‚‚è¡Œã‚ã›ãŸã„ãŸã‚ ``Webauthn Register Passwordless`` ã‚’ default action ã«è¨­å®šã—ã¾ã™ã€‚

![](/images/972c915c55327f/required_actions.png)

æœ€å¾Œã« ``Webauthn Passwordless Policy`` ã‚’è¦ä»¶ã«åˆã‚ã›ã¦è¨­å®šã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€``User verification requirement`` ã‚’ Required ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚

![](/images/972c915c55327f/required_actions.png)

# å‹•ä½œç¢ºèª

å‰è¿°ã®è¨­å®šã‚’è¡Œã£ãŸçŠ¶æ…‹ã§èµ·å‹•ã™ã‚‹æ§‹æˆã‚’ç”¨æ„ã—ãŸãŸã‚ã€ã“ã¡ã‚‰ã‚’ä½¿ç”¨ã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚

```sh
$ git clone https://github.com/kg0r0/keycloak-oidc-rp.git
$ cd keycloak-oidc-rp 
```

Keycloak ã® OpenID Connect Discovery Document ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã® URL ã«åŸºã¥ã„ãŸè¨­å®šãŒè¿”ã•ã‚Œã¾ã™[^7]ã€‚
ã“ã®ãŸã‚ Issuer ã®æ¤œè¨¼ã‚’æˆåŠŸã•ã›ã¤ã¤ WebAuthn API ã‚’ localhost ã§å‘¼ã³å‡ºã™ãŸã‚ã«ä»¥ä¸‹ã® ``extra_hosts`` ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

```yml:docker-compose.yml
version: "3.8"
services:
  rp:
    build: ./rp
    ports:
      - 3000:3000
    depends_on:
      - keycloak
    extra_hosts:
      - localhost:x.x.x.x # <= ã“ã®éƒ¨åˆ†ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›´
  keycloak:
    build: ./keycloak
    ports:
      - 8080:8080
      - 8443:8443
    volumes:
      - ./keycloak/import:/opt/keycloak/data/import
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ Keycloak (http://localhost:8080) ãŠã‚ˆã³ OIDC RP (http://localhost:3000) ãŒãã‚Œãã‚Œèµ·å‹•ã—ã¾ã™ã€‚

```bash
$ docker-compose build
$ docker-compose up -d
```

ã“ã“ã§ http://localhost:8080 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŠã‚ˆã³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãã‚Œãã‚Œ ``admin`` ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ ``demo`` ãƒ¬ãƒ«ãƒ ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãŠãã¾ã™ã€‚

## ç™»éŒ²

ã¾ãšã¯ OIDC RP (http://localhost:3000/login) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ OIDC ã®èªå¯ã‚³ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ã—ã¾ã™ã€‚
ã“ã®ã¨ãã€Keycloak ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¦ä»¥ä¸‹ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ ``[Register]`` ã‚’æŠ¼ä¸‹ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™»éŒ²ã«é€²ã¿ã¾ã™

![](/images/972c915c55327f/demo_flow_1.png)

ç™»éŒ²ç”»é¢ã§ã„ãã¤ã‹ã®æƒ…å ±ã®å…¥åŠ›ã‚’è¦æ±‚ã•ã‚Œã‚‹ãŸã‚é©å®œå…¥åŠ›ã—ã¦ ``[Register]`` ã‚’æŠ¼ä¸‹ã—ã¾ã™ã€‚

![](/images/972c915c55327f/demo_flow_2.png)

ã“ã“ã§ Security Key Registration ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ ``[Register]`` ã‚’æŠ¼ä¸‹ã—ã¦ç™»éŒ²ã‚’é€²ã‚ã¾ã™ã€‚

![](/images/972c915c55327f/demo_flow_3.png)

WebAuthn API ã®å®Ÿè¡Œã«ã‚ˆã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã€èªè¨¼å™¨ã®ç™»éŒ²ã‚’é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](/images/972c915c55327f/demo_flow_4.png)

ç™»éŒ²ãŒå®Œäº†ã™ã‚‹ã¨ OIDC ã®ãƒ•ãƒ­ãƒ¼ãŒå†é–‹ã•ã‚Œã€OIDC RP ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚ŒãŸã®ã¡ã« OIDC RP ã¯ ID Token ã‚’å–å¾—ã—ã¾ã™ã€‚

![](/images/972c915c55327f/demo_flow_6.png)

## èªè¨¼

ã¾ãšã¯ OIDC RP (http://localhost:3000/login) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ OIDC ã®èªå¯ã‚³ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ã—ã¾ã™ã€‚

![](/images/972c915c55327f/demo_flow_7.png)

å…ˆã»ã©ç™»éŒ²ã—ãŸèªè¨¼å™¨ã‚’ä½¿ç”¨ã—ã¦èªè¨¼ã‚’ãŠã“ãªã†ã“ã¨ãŒã§ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![](/images/972c915c55327f/demo_flow_8.png)

èªè¨¼ãŒè¡Œã‚ã‚Œã‚‹ã¨ OIDC RP ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã€ID Token ã‚’æ¤œè¨¼ã—ãŸã®ã¡ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å±æ€§æƒ…å ±ãŒç”»é¢ä¸Šã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![](/images/972c915c55327f/demo_flow_9.png)

# ãŠã‚ã‚Šã«

æœ¬æŠ•ç¨¿ã§ã¯ã€OpenID Connect (OIDC) ã¨ Web Authentication (WebAuthn) ã®é–¢é€£æ€§ã«è§¦ã‚Œã¤ã¤ã€Keycloak ã‚’ Identity Provider (IdP) ã¨ã—ã¦ä½¿ç”¨ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ãªèªè¨¼ã‚’å°å…¥ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
OIDC ãªã©ã® ID é€£æºã®ä»•æ§˜ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€è‡ªã‚‰ WebAuthn ã® RP ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãªã WebAuthn ã«ã‚ˆã‚‹èªè¨¼ã‚’ã‚µãƒ¼ãƒ“ã‚¹ã«å°å…¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ãŸã‚ã€WebAuth ã«ã‚ˆã‚‹èªè¨¼ã‚’ã‚µãƒ¼ãƒ“ã‚¹ã«å°å…¥ã™ã‚‹ã“ã¨ã‚’è€ƒãˆã‚‹å ´åˆã€åˆ©ç”¨ã™ã‚‹ IdP ã«ã©ã†ã„ã£ãŸæ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã€ã©ã®ã‚ˆã†ãªæ–¹æ³•ã§å°å…¥ã™ã‚‹ã®ãŒæœ€é©ã‹æ¤œè¨ã™ã‚‹ã“ã¨ãŒé‡è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã§ã¯ã¾ãŸï¼

[^1]: OpenID Connect Core 1.0 incorporating errata set 1 | https://openid.net/specs/openid-connect-core-1_0.html
[^2]: Web Authentication: An API for accessing Public Key Credentials Level 3 | https://www.w3.org/TR/webauthn-3/
[^3]: FIDO2: Web Authentication (WebAuthn) | https://fidoalliance.org/fido2-2/fido2-web-authentication-webauthn/
[^4]: FIDO TechNotes: Is FIDO Intended to Replace Federation Protocols? | https://fidoalliance.org/fido-and-federation-protocols-tech-note/
[^5]: Server Administration Guide | https://www.keycloak.org/docs/latest/server_admin/
[^6]: FIDO2 Passwordless Authentication With Keycloakâ€Š-â€ŠPart 2 | https://refactorfirst.com/setup-fido2-passwordless-authentication-with-keycloak
[^7]: Configuring the hostname | https://www.keycloak.org/server/hostname