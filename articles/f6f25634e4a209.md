---
title: "OAuth 2.1の差分を見守る会 : draft 04-05"
emoji: "🙆"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["OAuth", "ietf", "rfc"]
published: false
---

本投稿はOAuth 2.1って呼ばれたい感を出してる仕様の差分を見守る会です。

本投稿含め、差分を スクラップ - [OAuth 2.1を見守る会](https://zenn.dev/ritou/scraps/098107802f952b) でまとめています。

## 差分

[差分](https://tools.ietf.org/wg/oauth/draft-ietf-oauth-v2-1/draft-ietf-oauth-v2-1-05-from-04.wdiff.html)

[draft 05](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-05.txt) における主な差分としては、[Appendix E.  Document History](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-05.txt#appendix-E)に記載の以下の通りです。
変更差分の全体を見ると多くの差分があるように見えますが、章の移動などに伴うものが多そうです。大きな変更で言うと、implicit flow の削除に関する章の追加でしょうか。その他にも特に TLS に関する比較的細かい要件が色々と更新されているようです。

>   *  Added a section about the removal of the implicit flow
>
>  *  Moved many normative requirements from security considerations
>     into the appropriate inline sections
>
>   *  Reorganized and consolidated TLS language
>
>   *  Require TLS on redirect URIs except for localhost/custom URL
>     scheme
>
> *  Updated refresh token guidance to match security BCP
>

本投稿では、上記の内容を抑えつつ、その他の細かい変更点についても、ざっくりと確認していきます。

### 目次

目次における大きな差分としては以下の通りでした。その他の差分については、章の場所が移動しただけのものであり、特に削除されたり、新規に追加されたものは無さそうでした。

- TLS Version -> Communication security (変更)
- Endpoint Request Confidentiality (削除)
- Preventing CSRF Attacks (追加)
- Preventing Mix-Up Attacks (追加)
- Refresh Tokens (削除)
- Request Confidentiality (削除)
- Removal of the OAuth 2.0 Implicit grant (追加)
- Security Considerations in Native Apps (追加)

### 1.5. Communication security

章のタイトルが「TLS Version」から「Communication security」に変わっています。
内容に関しては、以前の「TLS Version」では、ざっくり適切なバージョンの TLS をいつでも利用することが要件として記載されていましたが、「Communication security」では、TLS に限定しないような記載に表現が変更されています。

>    Implementations MUST use a mechanism to provide communication authentication, integrity and confidentiality such as Transport-Layer Security [RFC8446], to protect the exchange of clear-text credentials and tokens either in the payload body or in header fields from eavesdropping, tampering, and message forgery (eg. see Section 2.4.1, Section 7.6, Section 3.2, and Section 5.2).

なお、ループバックインターフェースのリダイレクト URI は例外として http スキームを利用しても良いとの記載が追加されています。

>    OAuth URLs MUST use the https scheme except for loopback interface redirect URIs, which MAY use the http scheme. 

また、TLS のバージョンおよび利用されるアルゴリズムはこの仕様の範囲外であることが明記されました。

>    The identification of the TLS versions and algorithms is outside the scope of this specification. 

### 2.3.2. Registration Requirements

認可サーバーは、クライアントに対して複数のリダイレクト URI の登録を許可してもよいことの記載が追加されています。

>    The authorization server MAY allow the client to register multiple redirect URIs.

また、URI スキームの重複を考慮した要件が追記されています。

>    In addition to the collision-resistant properties, this can help to prove ownership in the event of a dispute where two apps claim the same private-use URI scheme (where one app is acting maliciously). For example, if two apps claimed com.example.app, the owner of example.com could petition the app store operator to remove the counterfeit app.  Such a petition is harder to prove if a generic URI scheme was used.

オープンリダイレクトを防ぐためのリダイレクト URI の要件がクライアント向けに追加されています。

>   Clients MUST NOT expose URLs that forward the user's browser to arbitrary URIs obtained from a query parameter ("open redirector"). Open redirectors can enable exfiltration of authorization codes and access tokens, see (#open_redirector_on_client).

クライアントは、リダイレクト URL をリクエストごとに変えるのではなく、別の状態を持つようなパラメーターを利用しても良い (MAY) とのことです。

>    The client MAY use the state request parameter to achieve per-request customization if needed rather than varying the redirect URI per request. 


### 2.3.3. Preventing CSRF Attacks

クライアントは CSRF 攻撃の対策をしなければならない (MUST) 要件が追記されています。

>  Clients MUST prevent Cross-Site Request Forgery (CSRF) attacks.  In this context, CSRF refers to requests to the redirection endpoint that do not originate at the authorization server, but a malicious third party (see Section 4.4.1.8. of [RFC6819] for details). 

具体的には、クライアントは、認可サーバーが code_challenge のリレーをサポートしていることを確認するように記載されています。

> Clients that have ensured that the authorization server supports the code_challenge parameter MAY rely the CSRF protection provided by that mechanism. 

また、OpenID Connect においては、CSRF 対策として nonce パラメーターの検証をするように記載があります。

> In OpenID Connect flows, validating the nonce parameter provides CSRF protection. 

そのほかの方法として、ワンタイムの CSRF トークンを state パラメーターとして利用することが記載されています。

> Otherwise, one-time use CSRF tokens carried in the state parameter that are securely bound to the user agent MUST be used for CSRF protection (see (#csrf_countermeasures)).

### 2.3.4. Preventing Mix-Up Attacks

以前は Protecting the Authorization Code Flow に含まれていた Mix-Up Attack の対策に関する要件が一つの章として記載されました。

### 2.3.5. Invalid Endpoint 

認可サーバーが認可リクエストに含まれるリダイレクト URI の検証に失敗した際の処理が追記されました。問題が発生した際はリソースオーナーにそのエラーを伝えるべきであること、また、そのエラーが発生したリダイレクト URI に対して自動でユーザーエージェントをリダイレクトしてはならないことが記載されています。

>   If an authorization request fails validation due to a missing, invalid, or mismatching redirect URI, the authorization server SHOULD inform the resource owner of the error and MUST NOT automatically redirect the user agent to the invalid redirect URI.

### 2.4.  Client Authentication

>   The authorization server MUST only rely on client authentication if the process of issuance/registration and distribution of the underlying credentials ensures their confidentiality.

クライアント認証が不可能なクライアント (= Public Client) を想定した要件が追記されました。

>   When client authentication is not possible, the authorization server SHOULD employ other means to validate the client's identity - for example, by requiring the registration of the client redirect URI or enlisting the resource owner to confirm identity.  A valid redirect URI is not sufficient to verify the client's identity when asking for resource owner authorization but can be used to prevent delivering credentials to a counterfeit client after obtaining resource owner authorization.

>   The authorization server MAY establish a client authentication method with public clients, which converts them to credentialed clients.However, the authorization server MUST NOT rely on credentialed client authentication for the purpose of identifying the client.

>   The authorization server MUST consider the security implications of interacting with unauthenticated clients and take measures to limit the potential exposure of tokens issued to such clients, (e.g., limiting the lifetime of refresh tokens).

>   The privileges an authorization server associates with a certain client identity MUST depend on the assessment of the overall process for client identification and client credential lifecycle management. See Section 7.2 for additional details.


### 3.1.  Authorization Endpoint

>    An authorization server that redirects a request potentially containing user credentials MUST avoid forwarding these user credentials accidentally (see Section 7.5.2 for details).

### 4.1.1.  Authorization Request

要件が一部追記されています。
以下の通り、認可サーバーは、code_challenge と code_verifier のサポートしなければならない (MUST) との要件が追記されました。

>   Authorization servers MUST support the code_challenge and code_verifier parameters.

以下の通り、state と scope パラメーターには、機密性の高いクライアントやリソースオーナーの情報を平文で含まれるべきではないとの要件が追記されました。

>   The state and scope parameters SHOULD NOT include sensitive client or resource owner information in plain text, as they can be transmitted over insecure channels or stored insecurely.


### 4.1.2.  Authorization Response

>    Clients MUST prevent injection (replay) of authorization codes into the authorization response by attackers.  Using code_challenge and code_verifier prevents injection of authorization codes since the authorization server will reject a token request with a mismatched code_verifier.  See Section 7.6 for more details.

### 4.1.3.  Token Endpoint Extension

redirect_uri の検証について、認可リクエストに redirect_uri が含まれていなかった場合に、redirect_uri パラメーターは OPTIONAL になることが追記されました。

>    "redirect_uri":  REQUIRED, if the redirect_uri parameter was included in the authorization request as described in Section 4.1.1, and in which case their values MUST be identical.  If no redirect_uri was included in the authorization request, this parameter is OPTIONAL.


### 4.3.  Refresh Token Grant

>   Refresh tokens MUST be kept confidential in transit and storage, and shared only among the authorization server and the client to whom the refresh tokens were issued.  The authorization server MUST maintain the binding between a refresh token and the client to whom it was issued.

### 5.2.  Bearer Tokens

>   To protect against access token disclosure, the communication interaction between the client and the resource server MUST utilize confidentiality and integrity protection as described in Section 1.5.

>    To mitigate the risk of access token capture and replay, the lifetime of the token MUST be limited.  One means of achieving this is by putting a validity time field inside the protected part of the token. Note that using short-lived tokens reduces the impact of them being leaked.

>    There is no requirement on the particular structure or format of a bearer token, as described in Section 5.  If a bearer token is a reference to authorization information, such references MUST be infeasible for an attacker to guess, such as using a sufficiently long cryptographically random string.  If a bearer token uses an encoding mechanism to contain the authorization information in the token itself, the access token MUST use integrity protection sufficient to prevent the token from being modified.  One example of an encoding and signing mechanism for access tokens is described in JSON Web Token Profile for Access Tokens [RFC9068].

### 7.15.  Other Recommendations

>   Authorization servers SHOULD NOT allow clients to influence their client_id or sub value or any other claim if that can cause confusion with a genuine resource owner (see (#client_impersonating)).

### 8.5. Security Considerations in Native Apps

以前は Security Considerations にまとめられていた Native App の Security Consideration が、それだけで新規の章として追記されました。
内容は以前 Security Considerations で記載されていたものと大差ありませんでした。

### 10.1.  Removal of the OAuth 2.0 Implicit grant

>   The OAuth 2.0 Implicit grant is omitted from OAuth 2.1 as it was deprecated in [I-D.ietf-oauth-security-topics].

>   The intent of removing the Implicit grant is to no longer issue access tokens in the authorization response, as such tokens are vulnerable to leakage and injection, and are unable to be sender-constrained to a client.  This behavior was indicated by clients using the response_type=token parameter.  This value for the response_type parameter is no longer defined in OAuth 2.1.

>   Removal of response_type=token does not have an effect on other extension response types returning other artifacts from the authorization endpoint, for example, response_type=id_token defined by [OpenID].

### 終わり

ではまた！