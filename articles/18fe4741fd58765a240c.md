---
title: "OSSã®API Gateway Kongã«OAuth2.0ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’å°å…¥ã™ã‚‹"
emoji: "ğŸ‘»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["oauth", "kong"]
published: true 
---

# ã¯ã˜ã‚ã«
æœ¬è¨˜äº‹ã§ã¯ã€OSSã®API Gatewayã§ã‚ã‚‹Kongã«OAuth2.0ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
OAuth2.0ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®å°å…¥ã«ã¯ã€[Kong Gateway OAuth2 Plugin](https://docs.konghq.com/hub/kong-inc/oauth2/)ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
å…¨ä½“æ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ç‰¹ç­†ã™ã¹ãç‚¹ã¨ã—ã¦ã¯ã€KongãŒãƒªã‚½ãƒ¼ã‚¹ã‚µãƒ¼ãƒãƒ¼ã ã‘ã§ãªãèªå¯ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦ã®å½¹å‰²ã‚‚æ‹…ã†ç‚¹ãŒã‚ã’ã‚‰ã‚Œã¾ã™ã€‚
ãªãŠã€æœ¬æ¥ã§ã‚ã‚Œã°èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’Kong Gateway OAuth2 PluginãŒå—ã‘å–ã‚Œã‚‹POSTã«å¤‰æ›ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (èªå¯ã‚µãƒ¼ãƒãƒ¼ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç›¸å½“) ãŒå¿…è¦ã«ãªã‚Šã¾ã™ãŒã€ä»Šå›ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ç›´æ¥POSTã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã„ã‚‹ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ (å¾Œè¿°)ã€‚

![](/images/18fe4741fd58765a240c/overview.png)

æœ¬è¨˜äº‹ã®å†…å®¹ã®å¤§éƒ¨åˆ†ã¯ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚
https://konghq.com/blog/kong-gateway-oauth2/
ã¾ãŸã€ä¸Šè¨˜ã®ãƒšãƒ¼ã‚¸ä¸­ã«ã‚‚ç’°å¢ƒæ§‹ç¯‰æ‰‹é †ã®è¨˜è¼‰ã¯ã‚ã‚Šã¾ã™ãŒã€ã‚ˆã‚Šç°¡å˜ã«æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«Docker Composeã§ä¸€é€šã‚Šç’°å¢ƒæ§‹ç¯‰ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã®ã§ã”åˆ©ç”¨ãã ã•ã„ã€‚
https://github.com/kg0r0/oauth-kong-example
ã‚µãƒ³ãƒ—ãƒ«ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä¸€å¼ãŒèµ·å‹•ã—ã¾ã™ã€‚ãªãŠã€ä»¥é™ã®æ‰‹é †ã§ã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ç’°å¢ƒãŒä¸€é€šã‚Šç«‹ã¡ä¸ŠãŒã£ã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¾ã™ã€‚
```bash
$ git clone https://github.com/kg0r0/oauth-kong-example.git
$ cd oauth-kong-example
$ docker-compose up -d 
```
â€»HTTPSé€šä¿¡ãŒKongã§çµ‚ç«¯ã—ã¦ã„ã‚‹ãªã©ã®ç´°ã‹ã„é•ã„ã¯ã‚ã‚Šã¾ã™ãŒã€å‹•ä½œã¨ã—ã¦å•é¡Œãªã„ã¨æ€ã„ã¾ã™ã€‚ã‚‚ã—ä¸å…·åˆãªã©ã‚ã‚Œã°Issueã‚„PRã‚’ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚

# Kong Gatewayã¨APIã‚µãƒ¼ãƒãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

æœ¬æ‰‹é †ã§ã¯ã€8001ç•ªãƒãƒ¼ãƒˆã®[Kong Admin API](https://docs.konghq.com/gateway-oss/0.10.x/admin-api/)ã‹ã‚‰è¨­å®šã‚’ãŠã“ãªã„ã¾ã™ã€‚ãªãŠã€API Gatewayã®å¾Œã‚ã®APIã«ã¯8000ç•ªãƒãƒ¼ãƒˆã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
Kongã«ãƒ—ãƒ­ã‚­ã‚·ã™ã‚‹APIã‚’ç™»éŒ²ã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€``step-on-api-server``ã¨ã—ã¦APIã‚’ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚
```bash
$ curl -k -X POST -H "Content-Type: application/json" -d '{"name":"step-on-api-server", "url":"http://api:3000"}' https://localhost:8001/services
{
  "retries": 5,
  "port": 3000,
  "protocol": "http",
  "client_certificate": null,
  "tls_verify_depth": null,
  "created_at": 1629142483,
  "updated_at": 1629142483,
  "connect_timeout": 60000,
  "write_timeout": 60000,
  "read_timeout": 60000,
  "tags": null,
  "name": "step-on-api-server",
  "path": null,
  "tls_verify": null,
  "ca_certificates": null,
  "id": "89eebfb2-dc68-4300-b834-e66e435c18e7",
  "host": "api"
}
```
æ¬¡ã«Kongã‚’ä»‹ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’APIã«è»¢é€ã™ã‚‹ãŸã‚ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€``/stepon``ã¨ã„ã†ãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸéš›ã«ã€å…ˆã»ã©ç™»éŒ²ã—ãŸ``step-on-api-server``ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚
```bash
$ curl -k -X POST -H "Content-Type: application/json" -d '{"name":"step-on-route", "service": {"name":"step-on-api-server"}, "paths": ["/stepon"]}' https://localhost:8001/routes
{
  "hosts": null,
  "paths": [
    "/stepon"
  ],
  "methods": null,
  "sources": null,
  "path_handling": "v0",
  "request_buffering": true,
  "response_buffering": true,
  "updated_at": 1629142497,
  "created_at": 1629142497,
  "id": "7a70a6e5-63fd-4d10-a2a8-97318c301645",
  "https_redirect_status_code": 426,
  "service": {
    "id": "89eebfb2-dc68-4300-b834-e66e435c18e7"
  },
  "regex_priority": 0,
  "snis": null,
  "strip_path": true,
  "destinations": null,
  "tags": null,
  "headers": null,
  "protocols": [
    "http",
    "https"
  ],
  "preserve_host": false,
  "name": "step-on-route"
}
```
ã“ã“ã¾ã§ã§ã€Kongã¨APIã®è¨­å®šã¯çµ‚ã‚ã‚Šã«ãªã‚Šã¾ã™
ã“ã“ã§ã€èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å«ã‚€ãƒ¢ãƒƒã‚¯ã®ãƒ˜ãƒƒãƒ€ã‚’ä»˜ä¸ã—ã¦çŠ¶æ…‹ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦æ­£å¸¸å¿œç­”ãŒå¾—ã‚‰ã‚Œã‚‹ã‹è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
```bash
$ curl -k -H "mock-logged-in-as: clark" https://localhost:8000/stepon/stepcounts
[
  {
    "date": "2021-01-01",
    "count": 2500
  },
  {
    "date": "2021-01-02",
    "count": 12000
  },
  {
    "date": "2021-01-03",
    "count": 9500
  }
]
```
ä¸Šè¨˜ã®ãƒ˜ãƒƒãƒ€ã¯[å…ƒã®è¨˜äº‹](https://konghq.com/blog/kong-gateway-oauth2#crayon-611d039f7931d479393071)ã®ã‚µãƒ³ãƒ—ãƒ«APIã‚³ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦ä»˜ä¸ã—ã¦ã„ã¾ã™ã€‚
Kong Gateway OAuth2.0 Pluginã‚’åˆ©ç”¨ã—ãŸå ´åˆã¯ã€``x-authenticated-userid``ã¨ã„ã†ãƒ˜ãƒƒãƒ€ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒé€ä¿¡ã•ã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚
ãã®ä»–ã«ãƒªã‚½ãƒ¼ã‚¹ã‚µãƒ¼ãƒãƒ¼å´ã§Kongã‹ã‚‰å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã‚‹æƒ…å ±ã«ã¤ã„ã¦ã¯[Upstream Headers](https://docs.konghq.com/hub/kong-inc/oauth2/#upstream-headers)ã‚’ã”è¦§ãã ã•ã„ã€‚

# OAuth2.0ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®æœ‰åŠ¹åŒ–

8001ç•ªãƒãƒ¼ãƒˆã®[Kong Admin API](https://docs.konghq.com/gateway-oss/0.10.x/admin-api/)ã‹ã‚‰OAuth2.0ã«é–¢é€£ã™ã‚‹è¨­å®šã‚’ãŠã“ãªã„ã¾ã™ã€‚
è¨­å®šå€¤ã«é–¢ã™ã‚‹è©³ç´°ã¯[ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒšãƒ¼ã‚¸](https://docs.konghq.com/hub/kong-inc/oauth2/)ã‚’ã”è¦§ãã ã•ã„ã€‚
ä»¥ä¸‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦OAuth2.0ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€ä¸»ã«è¨±å¯ã™ã‚‹ã‚¹ã‚³ãƒ¼ãƒ—ã®è¨­å®šã‚„èªå¯ã‚³ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼ã®æœ‰åŠ¹åŒ–ãªã©ã‚’è¡Œãªã£ã¦ã„ã¾ã™ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œã‚‹``provision_key``ã«ã¤ã„ã¦ã¯å¾Œã»ã©åˆ©ç”¨ã™ã‚‹ã®ã§ãƒ¡ãƒ¢ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚
```bash
$ curl -k -X POST -H "Content-Type: application/json" -d '{"name":"oauth2", "config": {"scopes":["user_profile", "biometric", "step_counts"], "mandatory_scope": true, "enable_authorization_code": true}, "protocols": ["https"]}' https://localhost:8001/services/step-on-api-server/plugins
{
  "created_at": 1629143302,
  "id": "f07fdaee-251c-41d6-8fb0-680cc70f7a9b",
  "name": "oauth2",
  "service": {
    "id": "89eebfb2-dc68-4300-b834-e66e435c18e7"
  },
  "route": null,
  "enabled": true,
  "tags": null,
  "protocols": [
    "https"
  ],
  "config": {
    "enable_client_credentials": false,
    "auth_header_name": "authorization",
    "accept_http_if_already_terminated": false,
    "scopes": [
      "user_profile",
      "biometric",
      "step_counts"
    ],
    "anonymous": null,
    "provision_key": "KB8zmkuKDd8lzt3u8y4sYE47H9SFgOrJ",
    "enable_authorization_code": true,
    "reuse_refresh_token": false,
    "token_expiration": 7200,
    "refresh_token_ttl": 1209600,
    "global_credentials": false,
    "pkce": "lax",
    "enable_password_grant": false,
    "hide_credentials": false,
    "mandatory_scope": true,
    "enable_implicit_grant": false
  },
  "consumer": null
}
```
ã¤ã¥ã„ã¦OAuth2.0ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (API Consumer) ã®è¨­å®šã‚’ã—ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ã«``/consumers``ã¨ã„ã†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦ç™»éŒ²ã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åå‰ã‚’æŒ‡å®šã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚
```bash
$ curl -k -X POST -H "Content-Type: application/json" -d '{"username": "shoeflyshoe"}' https://localhost:8001/consumers
{
  "username": "shoeflyshoe",
  "id": "73411a66-15b6-4680-a44c-4f3daaa86b52",
  "custom_id": null,
  "tags": null,
  "created_at": 1629143473
}
```
ä¸Šè¨˜ã§ç™»éŒ²ã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (API Consumer) ã®åå‰ã‚’ãƒ‘ã‚¹ã«å«ã‚ã€ãƒœãƒ‡ã‚£ã§ç™»éŒ²ã™ã‚‹ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã‚’æŒ‡å®šã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã§ã€``client_id``ã‚„``client_secret``ãŒå–å¾—ã§ãã¾ã™ã€‚
```bash
$ curl -k -X POST -H "Content-Type: application/json" -d '{"name": "Shoe Fly Shoe Customer Rewards", "redirect_uris": ["https://shoeflyshoe.store/oauth_return"]}' https://localhost:8001/consumers/shoeflyshoe/oauth2
{
  "created_at": 1629143669,
  "redirect_uris": [
    "https://shoeflyshoe.store/oauth_return"
  ],
  "name": "Shoe Fly Shoe Customer Rewards",
  "client_id": "1wyDxCGUgq0ugdezJy5EN4iktJ5197B5",
  "hash_secret": false,
  "client_type": "confidential",
  "tags": null,
  "id": "8fe80872-a63b-49fe-a46a-0e3ecb7fd63a",
  "consumer": {
    "id": "73411a66-15b6-4680-a44c-4f3daaa86b52"
  },
  "client_secret": "UFqTO2mmpNrm82aJLeWocwi8akM92FIH"
}
```
ã“ã“ã¾ã§ã§Clientã®ç™»éŒ²ãƒ»è¨­å®šã¯çµ‚äº†ã§ã™ã€‚
æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§OAuthã®ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ã„ãã¾ã™ã€‚

# OAuth2.0ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œ
ä»Šå›ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’curlã‚³ãƒãƒ³ãƒ‰ã§ä»£æ›¿ã—ã¾ã™ã€‚
ã¾ãŸã€æ—¢ã«è¨­å®šã—ãŸã¨ãŠã‚ŠOAuth2.0ã®èªå¯ã‚³ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼ã«æ²¿ã£ã¦å®Ÿè¡Œã—ã¾ã™ã€‚

## èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
ã¾ãšã€ä»¥ä¸‹ã®é€šã‚Šèªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆç›¸å½“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦èªå¯ã‚³ãƒ¼ãƒ‰ä»˜ãã®``redirect_uri``ãŒè¿”ã£ã¦ãã‚‹ã®ã§ã€User Agentã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã¾ã™ (èªå¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹) ã€‚
```bash
$ curl -k -X POST -H "Content-Type: application/json" -d '{"client_id": "1wyDxCGUgq0ugdezJy5EN4iktJ5197B5", "response_type": "code", "scope": "step_counts", "provision_key": "KB8zmkuKDd8lzt3u8y4sYE47H9SFgOrJ", "authenticated_userid": "clark", "redirect_url": "https://shoeflyshoe.store/oauth_return", "state": "xyz" }' https://localhost:8000/stepon/oauth2/authorize
{
  "redirect_uri": "https://shoeflyshoe.store/oauth_return?code=HIbSOblERaBIVZxepeZEfqezzCrXRa9m&state=xyz"
}
```
ä¸Šè¨˜ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å†’é ­ã®å…¨ä½“åƒã®(2)ã«ã‚ãŸã‚Šã€clarkã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒè¦æ±‚ã—ãŸscopeã‚’è¨±å¯ã—ãŸå¾Œã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚ã‚‹ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
ã¾ãŸã€OAuth2.0ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«åŠ ãˆã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç™»éŒ²æ™‚ã«å–å¾—ã—ãŸ``provision_key``ã¨ã„ã†å€¤ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
æœ¬æ¥ã®åˆ©ç”¨æ–¹æ³•ã¨ã—ã¦ã€[ã“ã¡ã‚‰](https://github.com/Kong/kong-oauth2-hello-world)ã®ã‚ˆã†ãªé€šå¸¸ã®GETã«ã‚ˆã‚‹èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã‚‹ã‚ˆã†ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç”¨æ„ã—ã€KongãŒå—ã‘å–ã‚Œã‚‹å½¢å¼ã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤‰æ›ã—ã¦é€ä¿¡ã—ã¾ã™ã€‚

## ãƒˆãƒ¼ã‚¯ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
ã¤ã¥ã„ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯å—ã‘ã¨ä»–èªå¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œã‚‹èªå¯ã‚³ãƒ¼ãƒ‰ã‚’åˆ©ç”¨ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚
```bash
$ curl -k -X POST -H "Content-Type: application/json" -d '{"grant_type": "authorization_code", "code": "HIbSOblERaBIVZxepeZEfqezzCrXRa9m", "client_id": "1wyDxCGUgq0ugdezJy5EN4iktJ5197B5", "client_secret": "UFqTO2mmpNrm82aJLeWocwi8akM92FIH" }' https://localhost:8000/stepon/oauth2/token
{
  "expires_in": 7200,
  "access_token": "dMaYaT2uHOOi1YrSZ1NEb5agzwhtL7jY",
  "token_type": "bearer",
  "refresh_token": "Cxu5Oq55ZKoAv3E0S6Nx4QZbjrZYGfN0"
}
```
ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŠã‚ˆã³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã¾ã—ãŸã€‚

## ä¿è­·ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯å–å¾—ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’åˆ©ç”¨ã—ã¦ã€Kong GatewayçµŒç”±ã§APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã™ã€‚
```bash
$ curl -k -H "Authorization: Bearer dMaYaT2uHOOi1YrSZ1NEb5agzwhtL7jY" https://localhost:8000/stepon/stepcounts
[
  {
    "date": "2021-01-01",
    "count": 2500
  },
  {
    "date": "2021-01-02",
    "count": 12000
  },
  {
    "date": "2021-01-03",
    "count": 9500
  }
]
```
ã‚‚ã¡ã‚ã‚“ã€èª¤ã£ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒ‡å®šã—ãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼ã¨ãªã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
```bash
$ curl -k -H "Authorization: Bearer dummy" https://localhost:8000/stepon/stepcounts
{
  "error": "invalid_token",
  "error_description": "The access token is invalid or has expired"
}
```
## ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°
ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¤ã„ã¦ã‚‚ã€[OAuth2.0ã®å®šç¾©ã©ãŠã‚Š](https://openid-foundation-japan.github.io/rfc6749.ja.html#token-refresh)Kongã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã§ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°ãŒå¯èƒ½ã«ãªã£ã¦ã„ã¾ã™ã€‚
```bash
$ curl -k -X POST -H "Content-Type: application/json" -d '{"grant_type": "refresh_token", "refresh_token": "Cxu5Oq55ZKoAv3E0S6Nx4QZbjrZYGfN0", "client_id": "1wyDxCGUgq0ugdezJy5EN4iktJ5197B5", "client_secret": "UFqTO2mmpNrm82aJLeWocwi8akM92FIH" }' https://localhost:8000/stepon/oauth2/token
{
  "expires_in": 7200,
  "access_token": "aMpSs6BoXZMF60s4BUAOIjpN1L7uKvqg",
  "token_type": "bearer",
  "refresh_token": "CS8ODf7IVI6yNtI62FX5FLlGOaiaqZGj"
}
```

# ãŠã‚ã‚Šã«

æ—¢å­˜ã®å®Ÿè£…ã«ä¾å­˜ã™ã‚‹ã“ã¨ãªãOAuth2.0ã«ã‚ˆã‚‹APIã®ä¿è­·ã‚’å®Ÿç¾ã™ã‚‹æ–¹æ³•ã®ä¸€ã¤ã¨ã—ã¦ã€OAuth2.0ã«å¯¾å¿œã—ãŸAPI Gatewayã®å°å…¥ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
ä»Šå›ç´¹ä»‹ã—ãŸKong Gateway OAuth Pluginã¯èªå¯ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦ã‚‚æŒ¯ã‚‹èˆã†ãŸã‚ã€OAuth2.0ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’ç°¡å˜ã«å°å…¥ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
ã‚‚ã¡ã‚ã‚“[OAuth2.0 Introspection plugin](https://docs.konghq.com/hub/kong-inc/oauth2-introspection/?_ga=2.268349838.1238457236.1629291871-2018084995.1628696333)ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã®èªå¯ã‚µãƒ¼ãƒãƒ¼ã«ã‚‚å¯¾å¿œã§ãã‚‹ãã†ãªã®ã§ã€æ—¢ã«åˆ©ç”¨ã—ã¦ã„ã‚‹èªå¯ã‚µãƒ¼ãƒãƒ¼ãŒã‚ã‚‹å ´åˆã§ã‚‚å°å…¥ã¯å¯èƒ½ãã†ã§ã™ã€‚

# å‚è€ƒ
- [4 Steps to Authorizing Services With the Kong Gateway OAuth2 Plugin](https://konghq.com/blog/kong-gateway-oauth2/)
- [OAuth 2.0 Authentication](https://docs.konghq.com/hub/kong-inc/oauth2/)
- [The OAuth 2.0 Authorization Framework](https://openid-foundation-japan.github.io/rfc6749.ja.html)