---
title: "Yubico PIV Tool ã«ã‚ˆã‚‹ YubiKey ã‚’åˆ©ç”¨ã—ãŸç½²å"
emoji: "ğŸ•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["yubikey"]
published: false
---

æœ¬æŠ•ç¨¿ã§ã¯ã€Yubico PIV Tool [^1]ã«ã‚ˆã‚Šã€YubiKey ã‚’åˆ©ç”¨ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãªã©ã«ç½²åã‚’è¡Œã†æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚
ãªãŠã€æœ¬æŠ•ç¨¿ã§ã¯ç½²åã«çµã£ã¦å‹•ä½œã‚’è¨˜è¼‰ã—ã¾ã™ãŒã€Yubico PIV Tool ã«ã¯ç½²åã«é™ã‚‰ãšæ§˜ã€…ãªæ©Ÿèƒ½ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã‚‚ã—ã€èˆˆå‘³ãŒã‚ã‚‹æ–¹ã¯é©å®œåŸæ–‡ã‚’ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚

# ã¯ã˜ã‚ã«

ã¾ãšã€Yubico PIV Tool ã®å–å¾—æ–¹æ³•ãŠã‚ˆã³å½“è©²ãƒ„ãƒ¼ãƒ«ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è¨˜è¼‰å†…å®¹ã«ã¤ã„ã¦ç°¡å˜ã«è§¦ã‚Œã¦ãŠãã¾ã™ã€‚

Yubico PIV Tool ã¯ã€å…¬å¼ãƒšãƒ¼ã‚¸ã® Releases[^2]ã‹ã‚‰ OS ã”ã¨ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã€ã“ã“ã‹ã‚‰å–å¾—ã™ã‚‹ã®ãŒæœ€ã‚‚ç°¡å˜ãªæ–¹æ³•ã ã¨æ€ã„ã¾ã™ã€‚
ãªãŠã€GitHub ãƒªãƒã‚¸ãƒˆãƒª[^3]ã‚‚å…¬é–‹ã•ã‚Œã¦ãŠã‚Šã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã‚ˆã†ã§ã™ãŒã€ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¿…è¦ã§ã‚ã‚‹ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

> cmake libtool libssl-dev pkg-config check libpcsclite-dev gengetopt help2man

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ[^4]ã«è¨˜è¼‰ã®é€šã‚Šã€YubiKey ã«ã¯ç”¨é€”ã®ç•°ãªã‚‹è¤‡æ•°ã®ã‚­ãƒ¼ã‚¹ãƒ­ãƒƒãƒˆãŒå­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚ä¾‹ãˆã°ã€ä»¥ä¸‹ã®é€šã‚Šã€ç½²åã®ã‚¹ãƒ­ãƒƒãƒˆã¯ 9c ã«ãªã£ã¦ãŠã‚Šã€ç”¨é€”ã«å¿œã˜ãŸã‚¹ãƒ­ãƒƒãƒˆã‚’äº‹å‰ã«ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

> -s, --slot=ENUM
> What key slot to operate on (possible values="9a", "9c", "9d", "9e", "82", "83", "84", "85", "86", "87", "88", "89", "8a", "8b", "8c", "8d", "8e", "8f", "90", "91", "92", "93", "94", "95", "f9")
>
> 9a is for PIV Authentication 9c is for Digital Signature (PIN always checked) 9d is for Key Management 9e is for Card Authentication (PIN never checked) 82-95 is for Retired Key Management f9 is for Attestation

ã¾ãŸã€ä¸Šè¨˜ã®é€šã‚Šã€ã‚¹ãƒ­ãƒƒãƒˆã«ã‚ˆã£ã¦ã¯ PIN ã‚’å¸¸ã«è¦æ±‚ã•ã‚Œã¾ã™ã€‚YubiKey ã® PIN ã‚’è¨­å®šã•ã‚ŒãŸè¦šãˆã®ãªã„æ–¹ã‚‚ã„ã‚‰ã£ã—ã‚ƒã‚‹ã‹ã¨æ€ã„ã¾ã™ãŒã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ[^1]ã«è¨˜è¼‰ã®é€šã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® PIN ã¯ ``123456`` ã«ãªã£ã¦ã„ã¾ã™ã€‚

> The default PIN code is 123456. The default PUK code is 12345678.

# ç½²å

Yubico PIV Tool ã«ã‚ˆã‚‹ç½²åã¯ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® Signing[^5] ã«è¨˜è¼‰ã®æ‰‹é †ã«æ²¿ã£ã¦è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
ãªãŠã€è‡ªåˆ†ãŒç¢ºèªã—ãŸæ™‚ç‚¹ã«ãŠã„ã¦ã€äº‹å‰ã«ã‚¹ãƒ­ãƒƒãƒˆ 9c ã«éµã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ãªã„å ´åˆã€ç½²åã™ã‚‹éš›ã« 6a80 ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰[^6]ãŒè¿”ã£ã¦ãã‚‹çŠ¶æ³ã§ã—ãŸã€‚ã—ãŸãŒã£ã¦ã€ã“ã“ã§ã¯ PKCS#12 å½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ã“ã‚ã‹ã‚‰å®Ÿæ–½ã—ã¾ã™ã€‚

## éµã®ä½œæˆ

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ[^5]ã«è¨˜è¼‰ã®é€šã‚Šã€åˆ©ç”¨å¯èƒ½ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯ RSA1024ã€ RSA2048ã€ ECCP256ã€ ECCP384 ã¨ãªã£ã¦ã„ã¾ã™ã€‚
ä¾‹ãˆã°ã€ãƒ–ãƒ­ã‚°[^7]ã«è¨˜è¼‰ã®æ‰‹é †ã«æ²¿ã£ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ãã“ã¨ã§ã€ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  ECCP256 ã§ PKCS#12 å½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã§ãã¾ã—ãŸã€‚

```bash
# generate a private key for a curve
$ openssl ecparam -name prime256v1 -genkey -noout -out private-key.pem

# generate corresponding public key
$ openssl ec -in private-key.pem -pubout -out public-key.pem

# optional: create a self-signed certificate
$ openssl req -new -x509 -key private-key.pem -out cert.pem -days 360

# optional: convert pem to pfx
$ openssl pkcs12 -export -inkey private-key.pem -in cert.pem -out cert.pfx
```

## ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ[^4]ã«è¨˜è¼‰ã®ä»¥ä¸‹ã®é€šã‚Š PKCS#12 å½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ­ãƒƒãƒˆ 9c ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

> Set a random chuid, import a key and import a certificate from a PKCS12 file, into slot 9c:
>
> yubico-piv-tool -s9c -itest.pfx -KPKCS12 -aset-chuid \
>  -aimport-key -aimport-cert

å®Ÿè¡Œçµæœã®ä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã«ãªã‚Šã¾ã™ã€‚

```bash
$ yubico-piv-tool -s9c -icert.pfx -KPKCS12 -aset-chuid \
                       -aimport-key -aimport-cert
Successfully set new CHUID.
Enter Password:
Successfully imported a new private key.
Successfully imported a new certificate.
```

## ç½²åãŠã‚ˆã³æ¤œè¨¼ 

ã“ã“ã¾ã§ã®æ‰‹é †ã§ç½²åã‚’è¡Œã†æº–å‚™ãŒã§ããŸã®ã§ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ[^5]ã«è¨˜è¼‰ã®æ‰‹é †ã«æ²¿ã£ã¦ã€ç½²ååŠã³æ¤œè¨¼ã‚’è¡Œã„ã¾ã™ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦ç½²åãŠã‚ˆã³æ¤œè¨¼ã‚’å®Ÿæ–½ã—ãŸéš›ã®å®Ÿè¡Œçµæœã®ä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```bash
$ yubico-piv-tool -a verify-pin --sign -s 9c -H SHA256 -A ECCP256 -i data.txt -o data.sig
Enter PIN:
Successfully verified PIN.
Signature successful!

$ openssl dgst -sha256 -verify public-key.pem -signature data.sig data.txt
Verified OK
```

ã¾ãŸã€æ¨™æº–å…¥åŠ›ã«å¯¾ã—ã¦ç½²åã‚’è¡Œã„ã€ã‚·ã‚°ãƒãƒãƒ£ã‚’æ¨™æº–å‡ºåŠ›ã™ã‚‹éš›ã¯ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
$ echo 'test' | yubico-piv-tool -a verify-pin --sign -s 9c -H SHA256 -A ECCP256 -i - -
Enter PIN:
Successfully verified PIN.
0D
ï¿½ï¿½ï¿½
Signature successful!
ï¿½$ï¿½ %#ï¿½ï¿½ï¿½Aï¿½\ï¿½.$ï¿½Cï¿½ï¿½ï¿½ï¿½qï¿½ï¿½ï¿½ï¿½2ï¿½ï¿½â
```

# ãŠã‚ã‚Šã« 

æœ¬æŠ•ç¨¿ã§ã¯ã€Yubico PIV Tool ã«ã‚ˆã‚Šã€YubiKey ã‚’åˆ©ç”¨ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãªã©ã«ç½²åã‚’è¡Œã†æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã—ãŸã€‚
YubiKey ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒåºƒãŒã£ã¦ã„ãã“ã¨ã§ã€éµç®¡ç†ãªã©ã«é–¢ã™ã‚‹æ‡¸å¿µã‚’ YubiKey ã«ä»»ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚·ãƒ¼ãƒ³ã‚‚å¢—ãˆã¦ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
æ˜æ—¥æŠ•ç¨¿äºˆå®šã®è¨˜äº‹ã§ã¯ã€å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æœ¬æ—¥ç´¹ä»‹ã—ãŸæ©Ÿèƒ½ã‚’çµ„ã¿è¾¼ã‚€éš›ã®ä¾‹ã‚’ç´¹ä»‹ã•ã›ã¦ã‚‚ã‚‰ãˆã‚Œã°ã¨æ€ã„ã¾ã™ã€‚
ã§ã¯ã¾ãŸã€‚

[^1]: Yubico PIV Tool https://developers.yubico.com/yubico-piv-tool/YubiKey_PIV_introduction.html  
[^2]: Releases https://developers.yubico.com/yubico-piv-tool/Releases/
[^3]: GitHub Yubico PIV Tool https://github.com/Yubico/yubico-piv-tool
[^4]: SYNOPSIS https://developers.yubico.com/yubico-piv-tool/Manuals/yubico-piv-tool.1.html
[^5]: Signing https://developers.yubico.com/yubico-piv-tool/Actions/signing.html
[^6]: PKCS8 cert fails to sign with code 6a80 https://github.com/Yubico/yubico-piv-tool/issues/222
[^7]: Creating Elliptic Curve Keys using OpenSSL https://www.scottbrady91.com/openssl/creating-elliptical-curve-keys-using-openssl 