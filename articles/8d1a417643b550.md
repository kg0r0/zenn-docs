---
title: "Yubikey PIV ã® Go å®Ÿè£…"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["yubikey", "Go"]
published: true 
---
Digital IdentityæŠ€è¡“å‹‰å¼·ä¼š #iddance Advent Calendar 2022 3 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

https://qiita.com/advent-calendar/2022/iddance

æœ¬æŠ•ç¨¿ã§ã¯ã€[piv-go](https://github.com/go-piv/piv-go)[^1] ã¨ã„ã† Yubikey PIV ã® Go ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¤ã„ã¦è¨˜è¼‰ã—ã¾ã™ã€‚
ã¾ãŸã€piv-go ã‚’åˆ©ç”¨ã—ã¦ Verifiable Presentation ã‚’ç”Ÿæˆã™ã‚‹å®Ÿé¨“çš„ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŠã‚ˆã³ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ã‚‚ä½œæˆã—ãŸã®ã§ç°¡å˜ã«èª¬æ˜ã—ã¾ã™ã€‚

# ã¯ã˜ã‚ã«

YubiKey PIV ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã«è¨˜è¼‰ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã¡ã‚‰ã‚’ã”è¦§ãã ã•ã„ã€‚ã¾ãŸã€æœ¬æŠ•ç¨¿ã§ã¯ã€ä»¥ä¸‹ã®è¨˜äº‹[^2]ã§èª¬æ˜ã—ã¦ã„ã‚‹ç½²åã‚’ piv-go ã§è¡Œã†æ–¹æ³•ã«çµã£ã¦èª¬æ˜ã—ã¾ã™ã€‚

https://zenn.dev/kg0r0/articles/25c403431f81aa

ä¸Šè¨˜ã®è¨˜äº‹ã«è¨˜è¼‰ã®é€šã‚Šã€YubiKey ã‚’åˆ©ç”¨ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãªã©ã«ç½²åã‚’è¡Œã†éš›ã€Yubico PIV Tool ãŒåˆ©ç”¨ã§ãã¾ã™ã€‚ã—ã‹ã—ã€ã‚‚ã—ã‚ãªãŸãŒ YubiKey ã‚’åˆ©ç”¨ã—ã¦ç½²åã‚’è¡Œã†æ©Ÿèƒ½ã‚’å«ã‚€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹å ´åˆã€Yubico PIV Tool ã¯å°‘ã—ä¸ä¾¿ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ä¾‹ãˆã°ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç’°å¢ƒã«äº‹å‰ã«ãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒç”Ÿã˜ãŸã‚Šã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç’°å¢ƒã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹å ´åˆã‚‚å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè¤‡æ•°å­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å®Ÿè£…ã¯ã€å®Ÿè£…ä¸å‚™ã‚’ä½œã‚Šè¾¼ã‚“ã å ´åˆã«é‡å¤§ãªè„†å¼±æ€§ã«ãªã‚‹å¯èƒ½æ€§ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
ã‚ãã¾ã§ä¾‹ã§ã™ãŒã€ä¸Šè¨˜ã®ã‚ˆã†ãªç†ç”±ã‹ã‚‰ã€Yubico PIV Tool ã‚’åˆ©ç”¨ã™ã‚‹ã®ã§ã¯ãªãã€ãªã‚‹ã¹ãä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å°‘ãªã„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰å‘¼ã³å‡ºã—ãŸã„çŠ¶æ³ãŒã‚ã‚Šã¾ã™ã€‚ã“ã†ã„ã£ãŸçŠ¶æ³ã«ãŠã„ã¦ã€piv-go[^1] ã®åˆ©ç”¨ãŒé¸æŠè‚¢ã®ä¸€ã¤ã«ãªã‚Šã¾ã™ã€‚
è‡ªèº«ã§ç¢ºèªã—ãŸé™ã‚Šã ã¨ã€YubiKey PIV ã®ãƒã‚¤ãƒ¬ãƒ™ãƒ«å®Ÿè£…ã¨ã—ã¦ã¯ã€piv-go[^1] ã®ä»–ã« go-ykpiv[^3] ãŒã‚ã‚Šã¾ã—ãŸãŒã€piv-go ã¯ go-ykpiv ã®ä»£æ›¿ã¨ãªã‚‹ã‚‚ã®ã§ã‚ã‚Šã€ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæœ€å°é™ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹å—ã‘ã‚‰ã¾ã—ãŸã€‚
ä¾‹ãˆã°ã€piv-go ã® Installation[^4] ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¼‰ã•ã‚Œã¦ãŠã‚Šã€ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæ¥µåŠ›å°‘ãªããªã‚‹ã‚ˆã†å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«è¦‹å—ã‘ã‚‰ã‚Œã¾ã™ã€‚

> On MacOS, piv-go doesn't require any additional packages.
> On Windows: No prerequisites are needed. The default driver by Microsoft supports all functionalities which get tested by unittests. However if you run into problems try the official YubiKey Smart Card Minidriver. Yubico states on their website the driver adds additional smart functionality.

# ç½²å

piv-go ã‚’åˆ©ç”¨ã—ã¦ç½²åã‚’è¡Œã†å ´åˆã€piv-go ã® Signing[^5] ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚è€ƒã«å„é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ã¾ãŸã€å„é–¢æ•°ã«ã¤ã„ã¦ã¯ Go Doc [^6] ã‚’é©å®œå‚ç…§ã—ã¾ã™ã€‚
è‡ªèº«ã§è©¦ã—ãŸã¨ã“ã‚ã€ä¾‹ãˆã°ã€Yubico PIV Tool ã«ã‚ˆã‚‹ YubiKey ã‚’åˆ©ç”¨ã—ãŸç½²å[^2]ã«è¨˜è¼‰ã—ãŸç½²ååŠã³æ¤œè¨¼æ‰‹é †ã‚’ piv-go ã§å®Ÿè£…ã—ãŸå ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```go: piv-go example
package main

import (
	"crypto"
	"crypto/ecdsa"
	"crypto/rand"
	"crypto/sha256"
	"encoding/asn1"
	"fmt"
	"math/big"
	"strings"

	"github.com/go-piv/piv-go/piv"
)

func main() {
	cards, err := piv.Cards()
	if err != nil {
		// ...
	}

	var yk *piv.YubiKey
	for _, card := range cards {
		if strings.Contains(strings.ToLower(card), "yubikey") {
			if yk, err = piv.Open(card); err != nil {
				// ...
			}
			break
		}
	}
	if yk == nil {
		// ...
	}

	if err := yk.Reset(); err != nil {
		fmt.Errorf("reset yubikey: %v", err)
	}

	slot := piv.SlotSignature

	key := piv.Key{
		Algorithm:   piv.AlgorithmEC256,
		TouchPolicy: piv.TouchPolicyAlways,
		PINPolicy:   piv.PINPolicyAlways,
	}
	pubKey, err := yk.GenerateKey(piv.DefaultManagementKey, slot, key)
	if err != nil {
		fmt.Errorf("generating key: %v", err)
	}
	pub, ok := pubKey.(*ecdsa.PublicKey)
	if !ok {
		fmt.Errorf("public key is not an ecdsa key")
	}
	auth := piv.KeyAuth{PIN: piv.DefaultPIN}
	data := sha256.Sum256([]byte("hello"))
	priv, err := yk.PrivateKey(slot, pub, auth)
	if err != nil {
		fmt.Errorf("getting private key: %v", err)
	}
	s, ok := priv.(crypto.Signer)
	if !ok {
		fmt.Errorf("expected private key to implement crypto.Signer")
	}
	out, err := s.Sign(rand.Reader, data[:], crypto.SHA256)
	if err != nil {
		fmt.Errorf("signing failed: %v", err)
	}
	var sig struct {
		R, S *big.Int
	}
	if _, err := asn1.Unmarshal(out, &sig); err != nil {
		fmt.Errorf("unmarshaling signature: %v", err)
	}
	if !ecdsa.Verify(pub, data[:], sig.R, sig.S) {
		fmt.Errorf("signature didn't match")
	}
}
```

ä¸Šè¨˜ã®é€šã‚Šã€piv-go ã§ã¯ type Key[^7] ã§ TouchPolicy ãªã©ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€å‰²ã¨æŸ”è»Ÿã« YubiKey ã®å‘¼ã³å‡ºã—æ–¹æ³•ãŒæŒ‡å®šã§ãã¾ã—ãŸã€‚
ã¾ãŸã€GenerateKey é–¢æ•°[^8]ã‚’åˆ©ç”¨ã—ã¦éµã®ç”ŸæˆãŠã‚ˆã³æŒ‡å®šã—ãŸã‚¹ãƒ­ãƒƒãƒˆã¸ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚‚ã§ãã‚‹ãŸã‚ã€æ‰‹å…ƒã§ PKCS#12 å½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹æ‰‹é †ãŒä¸è¦ã§ã—ãŸã€‚ãªãŠã€YubiKey PIV ã«é–¢ã™ã‚‹è¨­å®šã¯ Reset é–¢æ•°[^9]ã«ã‚ˆã‚Šãƒªã‚»ãƒƒãƒˆã§ãã‚‹ã‚ˆã†ã§ã—ãŸã€‚å…¬å¼ã® Go Doc[^9] ã«è¨˜è¼‰ã®ä»¥ä¸‹ã®é€šã‚Šã€Reset é–¢æ•°ã¯ GPG ã‚„ã€€U2F ãªã©ã®é ˜åŸŸã«ã¯å½±éŸ¿ã—ãªã„ãŸã‚ã€å¿…è¦ã«å¿œã˜ã¦ç”¨é€”ã‚’åˆ†ã‘ã¦ä½¿ãˆã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

> Reset resets the YubiKey PIV applet to its factory settings, wiping all slots and resetting the PIN, PUK, and Management Key to their default values. This does NOT affect data on other applets, such as GPG or U2F.

å‚è€ƒæƒ…å ±ç¨‹åº¦ã§ã™ãŒã€ä»¥ä¸‹ã« piv-go ã‚’åˆ©ç”¨ã—ã¦ç½²åãŠã‚ˆã³æ¤œè¨¼ã‚’è¡Œã†ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç½®ã„ã¦ã„ã‚‹ã®ã§ã€èˆˆå‘³ã®ã‚ã‚‹æ–¹ã¯å¿…è¦ã«å¿œã˜ã¦ã“ã¡ã‚‰ã‚‚ã”ç¢ºèªãã ã•ã„ã€‚

https://github.com/kg0r0/piv-go-example


# ykvp

piv-go ã‚’åˆ©ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¨ã—ã¦ã€Verifiable Presentation ã®ç”ŸæˆãŒã‚ã‚‹ã®ã§ã¯ãªã„ã‹ã¨ã„ã†ã“ã¨ã§ã€ä»¥ä¸‹ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ã‚’ä½œæˆã—ã¦é…ç½®ã—ã¦ã„ã¾ã™ã€‚
ãªãŠã€ã“ã‚Œã¯ãƒãƒƒã‚«ã‚½ãƒ³ã§çªè²«ã§ä½œã£ãŸã‚‚ã®ã§ã‚ã‚Šã€å¿…ãšã—ã‚‚ Verifiable Credentials Data Model ä»•æ§˜[^10]ã«æº–æ‹ ã—ã¦ã„ã‚‹ã‚‚ã®ã§ã¯ãªã„å®Ÿé¨“çš„ãªå®Ÿè£…ã§ã‚ã‚‹ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

https://github.com/KinyouBenkyokai/ykvp

Verifiable Presentation ã¨ã¯ Verifiable Credentials Data Model ä»•æ§˜[^10]ã«ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚Holder ãŒ Verifier ã« Verifiable Credential ã‚’æç¤ºã™ã‚‹éš›ã« Proof ã‚’ç”ŸæˆåŠã³ä»˜ä¸ã—ã€Verifiable Presentation ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã«ã—ã¾ã™ã€‚
ä¸Šè¨˜ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã¯ã€Verifiable Presentation ã® Proof ã®ç”Ÿæˆã‚’ YubiKey ã‚’ç”¨ã„ã¦è¡Œã„ã¾ã™ã€‚ãªãŠã€ã‚ãã¾ã§ Proof ã®ç”Ÿæˆã®ã¿ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ãŠã‚Šã€ç¾æ™‚ç‚¹ã§ã€Holder ã¨ Verifier é–“ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚„ã€æ¤œè¨¼ç”¨ã®éµã® Resolve ã®æ–¹æ³•ã«ã¤ã„ã¦ã¯ã‚¹ã‚³ãƒ¼ãƒ—å¤–ã§ã™ã€‚

ä¸Šè¨˜ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ãŸã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ã¨ã—ã¦ CLI ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚

https://github.com/KinyouBenkyokai/ykvp/tree/main/cmd/ykvpcli

ã“ã® CLI ã¯ Verifiable Credential ã‚’å…¥åŠ›ã¨ã—ã¦å—ã‘å–ã‚Šã€Verifiable Presentation ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

```bash
$ ykvpcli \ 
    -c '{"context":["https://www.w3.org/2018/credentials/v1"],"type":["GraduationCredential","VerifiableCredential"],"issuanceDate":"2022-11-06T20:40:25.560358+09:00","credentialSubject":{"id":"LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFd2VabHl4emtaL0xFQUdPNE9NMnJCYVliRnplRAorNnYrQmFzTW1hZWx2ZDNZNTZGR2RBQjY4UmZtYk05UVl4NUkvUlg4Qk1KZndSWDVhdFBuUFNXdlp3PT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tCg==","claim":{"age":24,"universityName":"Oxford","degree":"Bachelor of Science"}},"proof":{"type":"ecdsasecp256k1signature2019","created":"2022-11-06T20:40:25.560671+09:00","creator":{"Curve":{"P":1.1579208921035625e+77,"N":1.1579208921035625e+77,"B":4.105836372515214e+76,"Gx":4.8439561293906455e+76,"Gy":3.6134250956749796e+76,"BitSize":256,"Name":"P-256"},"X":6.72469815416677e+76,"Y":3.327515407817215e+76},"signature":"MEQCIBTOi0ZLu1E58GEhAalQl2FhRuc1EP6kPRj0aUBYV6kGAiBh9kRilqKLj1dk+xeTFmf2PXxjYgR0HEDeHI6xdvk0WA=="}}'
```

# ãŠã‚ã‚Šã« 

æœ¬æŠ•ç¨¿ã§ã¯ã€piv-go ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚ã¾ãŸã€piv-go ã‚’åˆ©ç”¨ã—ãŸã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ã«ã¤ã„ã¦ã‚‚ç´¹ä»‹ã—ã¾ã—ãŸã€‚
YubiKey ã«éµç®¡ç†ã‚’ä»»ã›ã‚‹ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã€éµç®¡ç†ãŒèª²é¡Œã®æŠ€è¡“é ˜åŸŸã«ãŠã‘ã‚‹è§£æ±ºç­–ã®ä¸€ã¤ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã¨æ€ã„ç´¹ä»‹ã•ã›ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚
ã§ã¯ã¾ãŸã€‚

[^1]: A Go YubiKey PIV implementation https://github.com/go-piv/piv-go  
[^2]: Yubico PIV Tool ã«ã‚ˆã‚‹ YubiKey ã‚’åˆ©ç”¨ã—ãŸç½²å https://zenn.dev/kg0r0/articles/25c403431f81aa
[^3]: go-ykpiv https://github.com/go-piv/go-ykpiv
[^4]: A Go YubiKey PIV implementation, Installation https://github.com/go-piv/piv-go#installation  
[^5]: A Go YubiKey PIV implementation, Signing https://github.com/go-piv/piv-go#signing  
[^6]: Documentation https://pkg.go.dev/github.com/go-piv/piv-go/piv
[^7]: type Key https://pkg.go.dev/github.com/go-piv/piv-go/piv#Key
[^8]: func (*YubiKey) GenerateKey https://pkg.go.dev/github.com/go-piv/piv-go/piv#YubiKey.GenerateKey
[^9]: func (*YubiKey) Reset https://pkg.go.dev/github.com/go-piv/piv-go/piv#YubiKey.Reset
[^10]: Verifiable Credentials Data Model v1.1 3.3 Presentations https://www.w3.org/TR/vc-data-model/#presentations
