---
title: "Keycloak ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèªè¨¼æ–¹å¼ private_key_jwt ã‚’ãŸã‚ã™"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["keycloak"]
published: true
---

Keycloak ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèªè¨¼æ–¹å¼ private_key_jwt ã‚’è©¦ã—ãŸéš›ã®æ‰‹é †ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«å€‹äººçš„ãªãƒ¡ãƒ¢ã¨ã—ã¦æ®‹ã—ã¦ãŠãã¾ã™ã€‚
ä»Šå›ã®å‹•ä½œç¢ºèªã«å¿…è¦ãªè¨­å®šãŒè¡Œã‚ã‚ŒãŸçŠ¶æ…‹ã§ Keycloak ãŒèµ·å‹•ã™ã‚‹ç’°å¢ƒã‚‚ç”¨æ„ã—ãŸã®ã§ã€å‹•ä½œç¢ºèªã¯ã“ã¡ã‚‰ã‚’ã‚‚ã¨ã«å®Ÿæ–½ã—ã¾ã™ã€‚

https://github.com/kg0r0/keycloak-signed-jwt

Keycloak ä¸Šã§ä½œæˆã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèªè¨¼æ–¹å¼ã®è¨­å®šã«é–¢ã™ã‚‹è©³ç´°ã¯ Keycloak ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ [Confidential client credentials](https://www.keycloak.org/docs/25.0.4/server_admin/#_client-credentials) ã‹ã‚‰ç¢ºèªã§ãã¾ã—ãŸã€‚

ä»Šå›è©¦ã™ private_key_jwt ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèªè¨¼æ–¹å¼ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹å ´åˆã€Client Authenticator ã¨ã—ã¦ Signed Jwt ã‚’é¸æŠã™ã‚‹ã‚ˆã†ã§ã™ã€‚

![](/images//c46023ea9f2a5e/client_authenticator.png)

ã¾ãŸã€ç½²åã®æ¤œè¨¼ã«ä½¿ç”¨ã•ã‚Œã‚‹éµã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãŠãã¾ã™ã€‚ã“ã®æ™‚ã®å½¢å¼ã¯æ•°ç¨®é¡ã®ä¸­ã‹ã‚‰é¸æŠã™ã‚‹ã“ã¨ãŒã§ã JSON Web Key Set ãªã©ã‚’é¸æŠã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ 

![](/images//c46023ea9f2a5e/generate_keys.png)

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèªè¨¼ã«ä½¿ç”¨ã™ã‚‹ JWT ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã«ã¤ã„ã¦ã¯ [OpenID Connect Core - 9. Client Authentication](https://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) ãªã©ã®ä»•æ§˜ã§ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä¾‹ãˆã°ã€ä»Šå›ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è¨­å®šã«ãŠã„ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¯ãƒ¬ãƒ¼ãƒ ã«ãªã‚Šã¾ã—ãŸã€‚

```bash
$ jwt decode eyJhdWQiOlsiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtc...

Token header
------------
{
  "typ": "JWT",
  "alg": "RS256"
}

Token claims
------------
{
  "aud": [
    "http://localhost:8080/realms/main/protocol/openid-connect/token"
  ],
  "exp": 1724280598,
  "iat": 1724280538,
  "iss": "sample-app",
  "jti": "90a43582-63f8-468d-8782-0a618399f9bc",
  "sub": "sample-app"
}
```

æœ€å¾Œã«ã€ä»Šå›ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ client credentials grant ã‚’è¨±å¯ã—ã¦ã„ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã“ã¨ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
$ curl -s -X POST http://localhost:8080/realms/main/protocol/openid-connect/token \
 -H "Content-Type: application/x-www-form-urlencoded" \
 -d "client_id=sample-app" \
 -d "grant_type=client_credentials" \
 -d "scope=openid" \
 -d "client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer" \
 -d "client_assertion=eyJhdWQiOlsiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtc..."
```

## References
- https://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication
- https://www.keycloak.org/docs/25.0.4/server_admin/#_client-credentials