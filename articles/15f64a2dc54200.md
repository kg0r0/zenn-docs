---
title: "ãƒ­ãƒ¼ã‚«ãƒ«ã§ Related Origin Requests (ROR) ã‚’è©¦ã—ãŸéš›ã®ãƒ¡ãƒ¢"
emoji: "ğŸ”‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["fido"]
published: true 
---

ãƒ­ãƒ¼ã‚«ãƒ«ã§ Related Origin Requests (ROR) [^1] ã‚’è©¦ã—ã¦ã¿ãŸã®ã§ãã®éš›ã®æ‰‹é †ã‚’å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¦ãŠãã¾ã™ã€‚
å‹•ä½œç¢ºèªã‚’è¡Œã†ã«ã‚ãŸã£ã¦ã€passkeys.dev[^1] ã® Example ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ ``https://shopping.com`` ã¨ ``https://shopping.co.uk`` ã¨ã„ã†ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ç”¨ã—ãŸã‚·ãƒŠãƒªã‚ªã«æ²¿ã£ã¦å†ç¾ã—ã¾ã—ãŸ[^2]ã€‚
ã¾ãŸã€å®Ÿè£…ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚ã™ã§ã« Autofill UI ãŒå‹•ä½œã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã„ãã¤ã‹ä¿®æ­£ã‚’åŠ ãˆã‚‹ã“ã¨ã§å‹•ä½œã•ã›ã¦ã„ã¾ã™ã€‚

https://github.com/kg0r0/passkey-autofill-example/tree/feat/ror

## RP å®Ÿè£…ã®å¤‰æ›´ç‚¹

ä¸»ã« RP ã«å¿…è¦ãªå¤‰æ›´ã¯ ``/.well-known/webauthn`` ã®å®Ÿè£…ã§ã™[^3]ã€‚ã“ã®ã¨ãã€``https://[RP ID]/.well-known/webauthn`` ã¨ãªã‚‹ã‚ˆã†ã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚  
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å½¢å¼ã¯ JSON ã§ã‚ã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ã« ``origins`` ã«æœ‰åŠ¹ãªã‚ªãƒªã‚¸ãƒ³ã®é…åˆ—ã‚’å«ã‚ã¦è¿”ã—ã¾ã™ã€‚

```json
{
  "origins": [
    "https://shopping.com",
    "https://myshoppingrewards.com",
    "https://myshoppingcreditcard.com",
    "https://myshoppingtravel.com",
    "https://shopping.co.uk",
    "https://shopping.co.jp",
    "https://shopping.ie",
    "https://shopping.ca"
  ]
}
```

ãªãŠã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒ Related Origin Requests ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹äº‹å‰ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®çŠ¶æ³ã‚’è¸ã¾ãˆãŸãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```js
        if (typeof PublicKeyCredential === 'undefined') {
          console.log("PublicKeyCredential is not supported in this browser.");
        }
        if (typeof PublicKeyCredential.getClientCapabilities === 'function') {
          let capabilities;
          try {
            capabilities = await PublicKeyCredential.getClientCapabilities();
            console.log(capabilities);
          } catch (error) {
            console.error('Error getting client capabilities:', error);
          }
          if (!capabilities.relatedOrigins) {
            console.log('Related Origin Requests (ROR) is not supported in this browser');
          }
        } else {
          console.log('getClientCapabilities is not supported in this browser');
        }
```

## å‹•ä½œç¢ºèª

å‹•ä½œç¢ºèªã‚’ã™ã‚‹ã†ãˆã§ã„ãã¤ã‹æº–å‚™ã‚’ãŠã“ãªã„ã¾ã™ã€‚
ã¾ãšã€``shopping.com`` ãŠã‚ˆã³ ``shopping.co.uk`` ã§ãƒ­ãƒ¼ã‚«ãƒ«ã® RP ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã« ``/etc/hosts`` ã«ä»¥ä¸‹ã®å®šç¾©ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```bash:/etc/hosts
127.0.0.1	localhost shopping.com shopping.co.uk
```

ã¾ãŸã€WebAuthentication API ã®å‘¼ã³å‡ºã—æ™‚ã®ã‚ªãƒªã‚¸ãƒ³ã¨ã—ã¦ ``localhost`` ä»¥å¤–ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã€HTTPS ã‹ã¤è¨¼æ˜æ›¸ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
ã“ã‚Œã«ã¤ã„ã¦ã¯ã€"Use HTTPS for local development"[^5] ã«è¨˜è¼‰ã®æ‰‹é †ã‚’è¡Œã†ã“ã¨ã§è¨¼æ˜æ›¸ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã‚ˆã†ã«ãƒ­ãƒ¼ã‚«ãƒ«ã§ HTTPS ã®ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  
ä¾‹ãˆã°ã€ä»Šå›ã«é–¢ã—ã¦ã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ ``shopping.com+1-key.pem`` ãŠã‚ˆã³ ``shopping.com+1.pem`` ãŒç”Ÿæˆã•ã‚Œã€``shopping.com`` ãŠã‚ˆã³ ``shopping.co.uk`` ã«è¨¼æ˜æ›¸ã‚¨ãƒ©ãƒ¼ç„¡ã—ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```bash
$ mkcert  shopping.com  shopping.co.uk
```

ã“ã“ã¾ã§ã§å‹•ä½œç¢ºèªã‚’ã™ã‚‹æº–å‚™ãŒã§ããŸã®ã§å®Ÿéš›ã« RP ã‚’èµ·å‹•ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚

```bash
$ git clone https://github.com/kg0r0/passkey-autofill-example.git
$ cd passkey-autofill-example
$ ls certs
shopping.com+1-key.pem shopping.com+1.pem
$  go run .
```

ã¾ãšã¯ã€``shopping.co.uk`` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ Passkeys ã®ç™»éŒ²ã‚’è¡Œã„ã¾ã™ã€‚

![](/images/15f64a2dc54200/registration_uk.png)

ã“ã®æ™‚ç‚¹ã§ ``shopping.co.uk`` ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã«å…ˆã»ã©ç™»éŒ²ã—ãŸ Passkeys ãŒä½¿ãˆã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

![](/images/15f64a2dc54200/authentication_uk.png)

æ¬¡ã«ã€``shopping.com`` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚ã“ã®ã¨ã RP ID ã¨ã—ã¦ ``shopping.co.uk`` ã‚’æŒ‡å®šã—ã¦ Web Authentication API ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

![](/images/15f64a2dc54200/authentication_com_1.png)

ã“ã“ã§ã€å¾“æ¥ã§ã‚ã‚Œã°ç¾åœ¨ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ã‚ªãƒªã‚¸ãƒ³ã¨ RP ID ã®ãƒŸã‚¹ãƒãƒƒãƒã«ã‚ˆã‚Š Web Authentication API ã®å‘¼ã³å‡ºã—ã«ãŠã„ã¦ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã¾ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ã« ``https://[RP ID]/.well-known/webauthn`` ã«å¯¾ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

```bash
$ go run .
2024/12/22 18:29:13 INFO shopping.co.uk/.well-known/webauthn
```

æœ€çµ‚çš„ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒå®Œäº†ã™ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

![](/images/15f64a2dc54200/authentication_com_2.png)

ãªãŠã€``https://shopping.co.uk/.well-known/webauthn`` ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œã‚‹ã‚ªãƒªã‚¸ãƒ³ã‹ã‚‰ ``https://shopping.com`` ã‚’å‰Šé™¤ã—ãŸå ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚

```bash
SecurityError: The RP ID "shopping.co.uk" is invalid for this domain
    at error (index.umd.min.js:2:3961)
    at e.startAuthentication (index.umd.min.js:2:4289)
    at async login:47:22Caused by: SecurityError: The relying party ID is not a registrable domain suffix of, nor equal to the current domain. Subsequently, fetching the .well-known/webauthn resource of the claimed RP ID was successful, but no listed origin matched the caller.
```

ä»Šå›ã¯ã¨ã‚Šã‚ãˆãš Related Origin Requests (ROR) ã®å‹•ä½œã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚ã§ã¯ã¾ãŸï¼

[^1]: https://passkeys.dev/docs/advanced/reloated-origins/#deployment-considerations
[^2]: https://passkeys.dev/docs/advanced/related-origins/#example
[^3]: https://passkeys.dev/docs/advanced/related-origins/#relying-party-changes
[^4]: https://passkeys.dev/docs/advanced/related-origins/#client-support
[^5]: https://web.dev/articles/how-to-use-local-https