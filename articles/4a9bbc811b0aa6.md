---
title: "OAuth 2.0 Nonce Endpoint draft 00 èª­æ›¸æ„Ÿæƒ³æ–‡"
emoji: "ğŸ“š"
type: "idea" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["OAuth"]
published: true 
---

## ã¯ã˜ã‚ã«

ãªã‚“ã‹ OAuth 2.0 Nonce Endpoint ã¨ã„ã†ä»•æ§˜ãŒå…¬é–‹ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚ã¨ã‚Šã‚ãˆãšã–ã£ãã‚Šã¨èª­ã‚“ã§ã¿ãŸã®ã§æ„Ÿæƒ³ã‚’å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¦ã¿ã¾ã™ã€‚

https://www.ietf.org/archive/id/draft-demarco-nonce-endpoint-00.html

## Abstract

OAuth 2.0 ã« Nonce Endpoint ã‚’å®šç¾©ã™ã‚‹ä»•æ§˜ã¨ã®ã“ã¨ã§ã™ã€‚Authorization Server ãŒ opaque ãª nonce ã‚’ç”ŸæˆãŠã‚ˆã³ç™ºè¡Œã™ã‚‹æ–¹æ³•ã¨ã€Client ãŒã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ nonce ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ãã†ã§ã™ã€‚

> This document defines the Nonce Endpoint for OAuth 2.0 implementations [RFC6749]. It details how an Authorization Server generates and issues opaque Nonces and how a client can learn about this endpoint to obtain a Nonce generated by the Authorization Server.


## 1.  Introduction

å¤§ä½“ Abstract ã¨åŒã˜ã“ã¨ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

> This specification presents a comprehensive guide to the Nonce endpoint in OAuth 2.0 implementations [RFC6749]. It describes in detail how a client can request and receive a server-generated Nonce, which is a unique, one-time use, opaque string. This document provides in-depth insights into the cryptographic methods used in generating Nonces to protect the confidentiality of the information associated with them. 

OAuth 2.0 ã‚’ä½¿ç”¨ã—ãªãŒã‚‰ã‚·ã‚¹ãƒ†ãƒ ã® scalabilityã€securityã€efficiency ã‚’å¼·åŒ–ã™ã‚‹ã¿ãŸã„ãªã“ã¨ãŒæ›¸ã„ã¦ã‚ã£ã¦æ°—ã«ãªã‚Šã¾ã™ã€‚

> In addition, it is a great resource for developers and system architects who desire to strengthen the scalability, security, and efficiency of their systems while using OAuth 2.0.


## 2. Conventions and Definitions

å‰²æ„›

## 3. Terminology

Nonce ã¯ãƒªãƒ—ãƒ¬ã‚¤ã‚¢ã‚¿ãƒƒã‚¯å¯¾ç­–ã®ä¸€åº¦ã®ã¿ä½¿ç”¨å¯èƒ½ãªå€¤ã¨ã„ã†ã“ã¨ã§ã™ã€‚
ã¾ãŸã€è¦‹æ…£ã‚Œãªã„ç”¨èªãŒã‚ã‚Šã¾ã™ã€‚Nonce Issuer ã¯é€šå¸¸ Authorization Serverã€€ã«ãªã‚Šã€Nonce Endpoint ã‚‚ Authorization Server ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãªã‚Šãã†ã§ã™ã€‚

> Nonce:
> A random or pseudo-random number that is generated for a specific use, typically for cryptographic communication. The Nonce is used to protect against replay attacks by ensuring that a message or data cannot be reused or retransmitted. The term "Nonce" stands for "number used once" and it MUST be unique within some scope.
>
> Nonce Issuer:
> The entity that generates and provides the Nonce. In the context of OAuth 2.0, the Nonce Issuer would typically be the Authorization Server.
>
> Nonce Endpoint:
> The HTTP endpoint provided by the Nonce Issuer for the issuance of the Nonces.

## 4. Requirements

Nonce Endpointã€Nonceã€Nonce Issuerã€Nonce ã® audience ãã‚Œãã‚Œã®è¦æ±‚äº‹é …ã«ã¤ã„ã¦è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ã€‚å€‹äººçš„ã«ç‰¹ã«æ°—ã«ãªã‚‹ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç´°ã‹ã„ã“ã¨ã¯æ™‚ãŒæ¥ãŸã‚‰è¦‹ã‚Œã°è‰¯ã„æ°—ãŒã—ã¾ã™ã€‚

> The Nonce Endpoint MUST satisfy the following requirements:
> ãƒ»Employ TLS for securitung the Endpoint [RFC5246].
> The Nonce MUST satisfy the following requirements:
> ãƒ»Pure opacity to recieving Clients.
> The Nonce Issuer MUST satisfy the following requirements:
> ãƒ»Generate a unique Nonce for each request to ensure the Nonce Issuer never produces identical Nonces, regardless of whether they occur simultaneously or at different times;
> ãƒ»Encrypt the Nonce with an encryption key that:
>   ãƒ»MUST NOT supplied by the Nonce Issuer to the Client;
>   ãƒ»MUST NOT disclosed by the Nonce Issuer to any external entity beyond its domain.
> The audiences of the Nonces satisfies the following requirements:
> The servers, within the Nonce Issuer's domain, SHOULD decrypt the Nonce and access its decrypted contents. No other entity might decrypt or know the decrypted contents of the Nonce.

## 5. Nonce Request

ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¾‹ã¯ã“ã‚“ãªæ„Ÿã˜ã‚‰ã—ã„ã§ã™ã€‚ç‰¹ã«è¨€ã†ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```
GET /nonce HTTP/1.1
Host: server.example.com
```

## 6. Nonce Response

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä¾‹ã¯ã“ã‚“ãªæ„Ÿã˜ã‚‰ã—ã„ã§ã™ã€‚ã“ã¡ã‚‰ã‚‚ç‰¹ã«è¨€ã†ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```
HTTP/1.1 200 OK
Content-Type: application/json

{
  "nonce": "d2JhY2NhbG91cmVqdWFuZGFt"
}
```

## 7. Nonce Endpoint Discovery

Authorization Server ãŒç‰¹å®šã®ãƒªã‚½ãƒ¼ã‚¹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã« Nonce ã‚’è¦æ±‚ã™ã‚‹ã«ã‚‚ã‹ã‹ã‚ã‚‰ãš Client ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ Nonce ã‚’æä¾›ã—ãªã„å ´åˆãªã©ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¤ã„ã¦è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚
ä¾‹ãˆã°ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ 400 ã§ ``nonce_required`` ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¤ã¤ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ ``Nonce-Endpoint-URI`` ã§ Nonce Endpoint ã‚’ä¼ãˆã‚‹ã¿ãŸã„ãªã“ã¨ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

```
HTTP/1.1 400 Bad Request
Nonce-Endpoint-URI: https://server.example.org/nonce-endpoint

{
  "error": "nonce_required",
  "error_description":
    "Authorization server requires the nonce in the request"
}
```

ãã®ã»ã‹ã«ã‚‚çŠ¶æ³ã«å¿œã˜ãŸç´°ã‹ã„å‹•ä½œã«ã¤ã„ã¦è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ã€‚

> In cases where, for some reasons, a correctly issued Nonce can no longer be considered valid by the Authorization Server that receives it, the Authorization Server MUST return the generic error "nonce_required" reporting the same description as "error_description", as if the Nonce had not been received. The cases when an issued Nonce is considered no longer valid MAY be caused by the rotation of the encryption keys, its expiration or other specific conditions internal to an implementation.

## 8. Non-normative Examples of a Nonce Payload

å¾©å·ã•ã‚ŒãŸ Nonce ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯æ§˜ã€…ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚„ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã€ãŠé¦´æŸ“ã¿ã® iatã€expã€aud ãªã©ã® claim ãŒå«ã¾ã‚Œã‚‹ã¨ã®ã“ã¨ã§ã™ã€‚
ä»¥ä¸‹ã¯ JSON serialized ã® Nonce ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ä¾‹ã¨ã®ã“ã¨ã§ã™ã€‚

```js
{
  "iss": "https://server.example.org",
  "iat": 1615908701,
  "exp": 1615995101,
  "source_endpoint": "https://server.example.org/nonce-endpoint",
  "aud": [
    "https://service.example.com/endpoint",
    "https://another.example.com/cb"
  ]
}
```

ãã‚‚ãã‚‚ encrypt ã«ã¤ã„ã¦ã‚„ã€exp ã‚„ iat ã‚’é™¤ã„ã¦ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ã‚’ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«å«ã‚ãªã‘ã‚Œã°ãªã‚‰ãªã„ã¿ãŸã„ãª Issue ã‚‚ã‚ãŒã£ã¦ã„ã¾ã™ã€‚

- [What does encrypt mean? ](https://github.com/peppelinux/draft-demarco-nonce-endpoint/issues/10)
- [payload must include a random value](https://github.com/peppelinux/draft-demarco-nonce-endpoint/issues/6)

ç¾æ™‚ç‚¹ã§ã‚ã‚“ã¾ã‚Šæ·±ãè€ƒãˆã¦ã‚‚ã¨ã„ã†æ°—ãŒã—ã¾ã™ãŒã€Nonce ã¯ä½•ã‹ã—ã‚‰ã®æ–¹æ³•ã§æš—å·åŒ–ã‚„ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸå€¤ã‚‚ä½¿ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒã“ã‚Œã¾ã§ã®å†…å®¹ã‹ã‚‰ã‚‚ç¤ºå”†ã•ã‚Œã¦ã„ã‚‹ã¨ã„ã£ãŸæ„Ÿã˜ã§ã™ã‹ã­ã€‚

## 9. Security Considerations

Security Considerations ã«ã¤ã„ã¦å‰²ã¨ç´°ã‹ãè¨˜è¼‰ãŒã‚ã‚Šã¾ã™ãŒã€ç‰¹ã«ç›®æ–°ã—ã„ã‚ˆã†ãªã‚‚ã®ã¯è¦‹å—ã‘ã‚‰ã‚Œãªã„æ°—ãŒã™ã‚‹ã®ã§å‰²æ„›ã—ã¾ã™ã€‚

> The Nonce Endpoint MUST be protected by TLS to prevent eavesdropping and man-in-the-middle attacks, therefore the practices defined in [BCP195] should be followed.
>
> The Nonce Issuer MUST securely generate and store the encryption key used to encrypt the Nonce. The robustness of the encryption key plays a crucial role in the security of the Nonce Endpoint. The following considerations MUST be taken into account:
> ...

## 10. Considerations about Nonce vs. jti

jti claim ã¨ Nonce ã®é•ã„ã‚’èª¬æ˜ã—ã¦ãã‚Œã‚‹ã‚‰ã—ã„ã§ã™ã€‚

> This section provides some thought about the main differences and scopes of the Nonce in compared to the jti claim defined in [RFC7519].

jti ã¨ Nonce ã¯ã©ã¡ã‚‰ã‚‚ãƒªãƒ—ãƒ¬ã‚¤ã‚¢ã‚¿ãƒƒã‚¯å¯¾ç­–ã«ä½¿ç”¨ã•ã‚Œã‚‹ãŒã€Nonce ã®æ–¹ãŒå®Ÿè£…ã®æŸ”è»Ÿæ€§ãŒé«˜ããƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ã¿ãªã•ã‚Œã‚‹ã‚‰ã—ã„ã§ã™ï¼Ÿ
ä¾‹ãˆã°ã€Nonce ã¯ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã§ä½œæˆãŠã‚ˆã³ç®¡ç†ãŒã§ãã‚‹ã¨ã„ã†ç‚¹ãŒæŒ™ã’ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

> Both jti and Nonces are used to prevent replay attacks, however Nonces offer more implementation flexibility and are considered best practice. They can be created and managed stateless (e.g., by issuing the hmac over the current time as the Nonce), as this document outlines.

ç´°ã‹ã„é•ã„ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®é€šã‚Šã¨ã®ã“ã¨ã§ã™ã€‚

> The main differences between the use of the jti and the Nonces can be summarized as follows:
> 1. Generation: Nonces are generated by the server, while jti is generated by the Client.
> 2. Storage: Nonces can be self-authenticating and self-contained and therefore need not be stored. A common way to achieve this is for the Nonce to contain content encrypted to the Authorization Server that creates it. On the other hand, checking jti properly definitely requires a store that is shared across all domains that the associated JWT can be presented in.
> 3. Lifetime: The life span difference between a Nonce and a jti is significant. Nonces are kept just until the Client responds, which happens practically immediately after they are obtained, resulting in a very short lifespan. A jti, on the other hand, must be stored until the expiration window of its associated JWT expires, which is a substantially longer length than that of a Nonce.
> 4. Security: Nonces prevent replay attacks by ensuring that the proof of possession is fresh. On the other hand, jti does not guarantee freshness and using client-generated timestamps has problems, even for non-attacking Clients (e.g. devices with incorrect time-zones or daylight saving settings).

## 11. IANA Considerations

å‰²æ„›

## 12. References

å‰²æ„›

## ãŠã‚ã‚Šã«

ãã†ãˆã„ã°ã€Authorization Server ãŒ Nonce ã‚’ç™ºè¡Œã™ã‚‹ã¿ãŸã„ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«é–¢ã—ã„ãˆã°ã€"[OAuth 2.0 Demonstrating Proof of Possession (DPoP) | 8. Authorization Server-Provided Nonce ](https://datatracker.ietf.org/doc/html/rfc9449#name-authorization-server-provid)" ã¨ã„ã£ãŸãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒã‚ã£ãŸã“ã¨æ€ã„å‡ºã—ã¾ã—ãŸã€‚
ä¸€æ–¹ã§ã€ç¾æ™‚ç‚¹ã§ã¯ã“ã®ä»•æ§˜ã‚’ä½¿ã„ãŸã„ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒã©ã®ãã‚‰ã„ã‚ã‚‹ã®ã‹ãªã‚ã¨ã„ã†å°è±¡æŒã¡ã€ã‚‚ã†å°‘ã—ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚ãŸã‚ŠãŒçŸ¥ã‚ŠãŸã‹ã£ãŸãªã¨æ€ã„ã¾ã—ãŸã€‚

ã§ã¯ã¾ãŸï¼
