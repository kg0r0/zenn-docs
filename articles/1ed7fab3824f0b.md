---
title: "Okta - OAuth2.0 Device Authorization Grantã®è¨­å®šã¨ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["oauth", "ssh"]
published: false
---
# ã¯ã˜ã‚ã«

æœ¬è¨˜äº‹ã§ã¯ã€Oktaã®ãƒ‡ãƒã‚¤ã‚¹ãƒ•ãƒ­ãƒ¼ï¼ˆ[RFC 8628 OAuth 2.0 Device Authorization Grant](https://datatracker.ietf.org/doc/html/rfc8628)ï¼‰ã®è¨­å®šæ–¹æ³•ãŠã‚ˆã³ã€ãƒ‡ãƒã‚¤ã‚¹ãƒ•ãƒ­ãƒ¼ã‚’åˆ©ç”¨ã—ãŸSSHæ¥ç¶šã®ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚
ãƒ‡ãƒã‚¤ã‚¹ãƒ•ãƒ­ãƒ¼ã¯Webãƒ–ãƒ©ã‚¦ã‚¶éæ­è¼‰ã®ãƒ‡ãƒã‚¤ã‚¹ã‚„ã€æ–‡å­—å…¥åŠ›ãŒå›°é›£ãªãƒ‡ãƒã‚¤ã‚¹ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ãªã‚‹å ´åˆã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰¿èªã«åŸºã¥ã„ã¦ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹ãŸã‚ã®èªå¯ãƒ•ãƒ­ãƒ¼ã§ã™ã€‚
ãƒ‡ãƒã‚¤ã‚¹ãƒ•ãƒ­ãƒ¼è‡ªä½“ã¯æ¯”è¼ƒçš„æ–°ã—ã„ä»•æ§˜ã§ã™ãŒã€Oktaä»¥å¤–ã«ã‚‚å®Ÿè£…ã—ã¦ã„ã‚‹èªå¯ã‚µãƒ¼ãƒãƒ¼ã¯è¤‡æ•°å­˜åœ¨ã—ã¾ã™ã€‚
ã¾ãŸã€ãƒ‡ãƒã‚¤ã‚¹ãƒ•ãƒ­ãƒ¼ã‚’è§£èª¬ã—ã¦ã„ã‚‹è¨˜äº‹ã‚‚è¤‡æ•°ã‚ã‚‹ãŸã‚ã€ãƒ‡ãƒã‚¤ã‚¹ãƒ•ãƒ­ãƒ¼è‡ªä½“ã®è§£èª¬ã¯ãã¡ã‚‰ã‚’ã”è¦§ãã ã•ã„ã€‚
ä¾‹ãˆã°ã€æ—¥æœ¬èªã ã¨ä»¥ä¸‹ã®è¨˜äº‹ã¯å…¨ä½“æ„Ÿã‚‚å«ã‚ã¦éå¸¸ã«ã‚ã‹ã‚Šã‚„ã™ãè§£èª¬ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://www.authlete.com/ja/developers/device_flow/

# ãƒ‡ãƒã‚¤ã‚¹ãƒ•ãƒ­ãƒ¼ã®è¨­å®š
æœ¬è¨˜äº‹ã§ã¯ä»¥ä¸‹ã®ã‚¬ã‚¤ãƒ‰ã‚’ã‚‚ã¨ã«è¨­å®šã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚
https://developer.okta.com/docs/guides/device-authorization-grant/main/

## äº‹å‰æº–å‚™
äº‹å‰æº–å‚™ã¨ã—ã¦ã€Oktaã® Developerã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç”¨æ„ã—ã€``Settings > Features``ã‹ã‚‰``OAuth 2.0 Device Authorization Grant``ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚
![](/images/1ed7fab3824f0b/settings-features.png)
ãªãŠã€ä»Šå›ã®è¨˜äº‹ã®å†…å®¹ã¯ãƒ•ãƒªãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š
``Applications > Applications``ã‹ã‚‰OpenID Connectã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ãƒ‡ãƒã‚¤ã‚¹ãƒ•ãƒ­ãƒ¼ã®è¨­å®šã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚
![](/images/1ed7fab3824f0b/applications.png)

``Create App Integration``ã‹ã‚‰``OIDC``ã¨``Native Application``ã‚’ãã‚Œãã‚Œé¸æŠã—ã¾ã™ã€‚
![](/images/1ed7fab3824f0b/app-integration.png)
ã¤ã¥ã„ã¦ã€ä½œæˆã—ãŸOIDCã®Native Applicationã®è¨­å®šã‹ã‚‰ã€Grant Typeã¨ã—ã¦``Device Authorization``ã‚’é¸æŠã—ã¦ãŠãã¾ã™ã€‚
![](/images/1ed7fab3824f0b/grant-type.png)
ã“ã‚Œã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ‡ãƒã‚¤ã‚¹ãƒ•ãƒ­ãƒ¼ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## èªå¯ã‚µãƒ¼ãƒãƒ¼ã®ãƒãƒªã‚·ãƒ¼å¤‰æ›´ 
ã“ã®ã¾ã¾ã ã¨ã€èªå¯ã‚µãƒ¼ãƒãƒ¼ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ãªã„ã®ã§ã€ãƒãƒªã‚·ãƒ¼ã‚’å¤‰æ›´ã—ã¦ãŠãã¾ã™ã€‚
ã“ã“ã§ã¯ã€``Security > API``ã‹ã‚‰"default"ã®ã‚«ã‚¹ã‚¿ãƒ èªå¯ã‚µãƒ¼ãƒãƒ¼ã®ãƒãƒªã‚·ãƒ¼ã‚’å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚
![](/images/1ed7fab3824f0b/authz-server.png)
ãƒãƒªã‚·ãƒ¼ã®å¤‰æ›´ç”»é¢ã«ãŠã„ã¦``Device Authorization``ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãŠãã¾ã™ã€‚
![](/images/1ed7fab3824f0b/policy.png)
ã“ã‚Œã§ã€èªå¯ã‚µãƒ¼ãƒãƒ¼ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒã‚¤ã‚¹ã®è¨­å®š 

ã“ã“ã¾ã§ã®è¨­å®šã§Device Authorization GrantãŒåˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒã‚¤ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹æƒ³å®šã§å‹•ä½œç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

### device verification codeã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

ã¾ãšã€ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒã‚¤ã‚¹ã¯æœ€åˆã«``/device/authoriza``ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€verification codeã‚’å…¥æ‰‹ã—ã¾ã™ã€‚

```bash
curl --request POST \
  --url https://${yourOktaDomain}/oauth2/default/v1/device/authorize \
  --header 'Accept: application/json' \
  --header 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'client_id=${clientId}' \
  --data-urlencode 'scope=openid profile offline_access' | jq
{
    "device_code": "4ebdb4de-1f8b-4497-be01-ddfaf83c4e9c",
    "user_code": "MHXTFRPK",
    "verification_uri": "https://${yourOktaDomain}/activate",
    "verification_uri_complete": "https://${yourOktaDomain}/activate?user_code=MHXTFRPK",
    "expires_in": 600,
    "interval": 5
}
```
(â€»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¯[Request the device verification code](https://developer.okta.com/docs/guides/device-authorization-grant/main/#request-the-device-verification-code)ã‹ã‚‰å¼•ç”¨)

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œã‚‹``verification_uri_complete``ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€Oktaã®ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«é·ç§»ã—ã€ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã§ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒã‚¤ã‚¹ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆã•ã‚Œã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
![](/images/1ed7fab3824f0b/device-activate.png)

### ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã€IDãƒˆãƒ¼ã‚¯ãƒ³ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ 

ä¸Šè¨˜ã®æ‰‹é †ã‚’å®Ÿæ–½ã™ã‚‹ã¨ã€ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒã‚¤ã‚¹ã¯èªå¯ã‚µãƒ¼ãƒãƒ¼ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å„ç¨®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ä»¥ä¸‹ã¯ã€å®Ÿéš›ã«å„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãªã‚Šã¾ã™ã€‚
```bash
curl --request POST \
  --url https://${yourOktaDomain}/oauth2/default/v1/token \
  --header 'Accept: application/json' \
  --header 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'client_id=${clientId}' \
  --data-urlencode 'grant_type=urn:ietf:params:oauth:grant-type:device_code' \
  --data-urlencode 'device_code=${deviceCode}' | jq
{
  "token_type": "Bearer",
  "expires_in": 3600,
  "access_token": "eyJ ... ",
  "scope": "offline_access openid profile",
  "id_token": "eyJ ... "
}
```
ã“ã‚Œã§ã€Webãƒ–ãƒ©ã‚¦ã‚¶éæ­è¼‰ã®ãƒ‡ãƒã‚¤ã‚¹ç›¸å½“ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰¿èªã«ã‚‚ã¨ã¥ã„ã¦ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

# ãŠã¾ã‘: Device Authorization Grantã‚’åˆ©ç”¨ã—ãŸSSHæ¥ç¶š

Device Authorization Grantã‚’åˆ©ç”¨ã—ã¦SSHã‚’å¯èƒ½ã«ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã®ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ã¯SSHæ¥ç¶šã‚’ã™ã‚‹éš›ã«ã€ID/PWã‚„å…¬é–‹éµã«ã‚ˆã‚‹èªè¨¼ã§ã¯ãªãã€Device Authorization Grantã‚’åˆ©ç”¨ã—ã¦ã€Oktaã§æ‰¿èªã—ãŸã†ãˆã§æ¥ç¶šã‚’è¨±å¯ã™ã‚‹ã¨ã„ã†ã‚‚ã®ã«ãªã£ã¦ã„ã¾ã™ã€‚
https://github.com/oktadev/okta-ssh-oauth-example
ä¸Šè¨˜ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã¯Dockerfileã‚‚ç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚„Oktaã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãªã©ã‚’è‡ªèº«ã®ã‚‚ã®ã«ç½®ãæ›ãˆã‚‹ã ã‘ã§ç°¡å˜ã«å‹•ä½œã‚’è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
æ‰‹é †é€šã‚Šã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ãŸPAMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€Ubuntuã«å¯¾ã—ã¦Device Authorization Grantã§SSHæ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
å®Ÿéš›ã«SSHã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«``https://${yourOktaDomain}/activate``ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚ˆã†ä¿ƒã•ã‚Œã¾ã™ã€‚
![](/images/1ed7fab3824f0b/deviceflowSSHScreenshot.png)
(å¼•ç”¨å…ƒ: https://github.com/oktadev/okta-ssh-oauth-example)
ä¸Šè¨˜ã®æŒ‡å®šã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨Oktaã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¦æ±‚ã•ã‚Œã‚‹ã®ã§ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå¾Œã«ã€SSHæ¥ç¶šé–‹å§‹æ™‚ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã“ã¨ã§SSHæ¥ç¶šã‚’å®Œäº†ã—ã¾ã™ã€‚

# å‚è€ƒ
- https://datatracker.ietf.org/doc/html/rfc8628
- https://developer.okta.com/docs/guides/device-authorization-grant/main/
- https://github.com/oktadev/okta-ssh-oauth-example