---
title: "SimpleWebAuthn ã§å®Ÿè£…ã—ãŸ WebAuthn RP ã§ Passkeys ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹éš›ã®å‹˜æ‰€ (TypeScript)"
emoji: "ğŸ”‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["fido"]
published: false
---

Digital Identity æŠ€è¡“å‹‰å¼·ä¼š #iddance Advent Calendar 2023 4 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

https://qiita.com/advent-calendar/2023/iddance

æœ¬æŠ•ç¨¿ã§ã¯ã€SimpleWebAuthn[^1] ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ Web Authentication (WebAuthn) ã® Relying Party (RP) ã‚’å®Ÿè£…ã—ãŸå ´åˆã« Passkeys[^2] ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

WebAuthn ã® RP ã‚’å®Ÿè£…ã™ã‚‹éš›ã®å‹˜æ‰€ãªã©ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã§è¨˜è¼‰ã—ã¦ã„ã‚‹ã®ã§ã€ãã¡ã‚‰ã‚’ã”ç¢ºèªãã ã•ã„ã€‚

https://zenn.dev/kg0r0/articles/c271abb1ab2b76

## ã¯ã˜ã‚ã«

SimpleWebAuthn[^1] ã‚’ä½¿ç”¨ã—ã¦å®Ÿè£…ã—ãŸ WebAuthn ã§ RP ã§ Passkeys ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªè¨­å®šã¯ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://simplewebauthn.dev/docs/advanced/passkeys

ã“ã®ã¨ãã€å‰æã¨ã—ã¦ WebAuthn ã®ç™»éŒ²ãŠã‚ˆã³èªè¨¼ãƒ•ãƒ­ãƒ¼[^3]ã‚’ç†è§£ã—ã€ã©ã®å‡¦ç†ã«é–¢ä¿‚ã™ã‚‹è¨­å®šã§ã‚ã‚‹ã‹ã‚’ç†è§£ã—ã¦ãŠãã“ã¨ãŒé‡è¦ã¨æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

https://www.w3.org/TR/webauthn-3/#sctn-api

ã¾ãŸã€æœ¬æŠ•ç¨¿ã§è§¦ã‚Œã‚‹è¨­å®šã¯ Passkeys ã®ä»•æ§˜ã‚„å‹•ä½œã«é–¢ä¿‚ã™ã‚‹ã‚‚ã®ã§ã‚ã‚Šã€é©å®œä»¥ä¸‹ã® passkeys.dev[^4] ã®ã‚ˆã†ãª Passkeys ã«é–¢ã—ã¦è¨€åŠã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

https://passkeys.dev/docs/intro/what-are-passkeys/

## å®Ÿè£…ä¾‹

SimpleWebAuthn ã‚’ä½¿ç”¨ã—ãŸ WebAuthn ã® RP ã®å®Ÿè£…ä¾‹ã«ã¤ã„ã¦ã¯ã€SimpleWebAuthn ã®ãƒªãƒã‚¸ãƒˆãƒªä¸Šã® example ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸Šã«å­˜åœ¨ã—ã¦ãŠã‚Šã€ã“ã¡ã‚‰ã‹ã‚‰ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ãƒªãƒã‚¸ãƒˆãƒªä¸Šã®å®Ÿè£…ä¾‹ã‚’é©å®œå¤‰æ›´ã—ãªãŒã‚‰å‹•ä½œã‚’ç¢ºèªã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

https://github.com/MasterKale/SimpleWebAuthn/tree/master/example

ã¾ãŸã€åˆ¥ã®è¨˜äº‹ã§ç´¹ä»‹ã—ãŸå®Ÿè£…ä¾‹ã§ Passkeys å¯¾å¿œã•ã›ãŸã‚‚ã®ã‚’ passkeys ãƒ–ãƒ©ãƒ³ãƒã¨ã—ã¦å®Ÿè£…ã—ã¦ã„ã¾ã™ã®ã§å¿…è¦ã«å¿œã˜ã¦ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚ãªãŠã€ã‚ãã¾ã§å‹•ä½œç¢ºèªç”¨ã®å®Ÿè£…ã§ã‚ã‚Šã€ç¶²ç¾…çš„ãªä¾‹å¤–å‡¦ç†ãªã©ã¯ãŠã“ãªã‚ã‚Œã¦ã„ãªã„ç‚¹ã«ã¯æ³¨æ„ã—ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

https://github.com/kg0r0/simplewebauthn-example/tree/passkeys


## ç™»éŒ²

æ¬¡ã®å›³ã«ã‚‚ã¨ã¥ã„ã¦ç™»éŒ²å‡¦ç†ã‚’èª¬æ˜ã—ã¾ã™ã€‚

![Registration Flow](/images/129ae1819296dd/webauthn-registration-flow-01.png)
_Registration Flow[^4]_

### Relying Party Server

SimpleWebAuthn ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã®ä»¥ä¸‹ 2 ç‚¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

> 1. Generate a discoverable credential. The authenticator must generate and internally store a credential mapped to (rpID + userID).
> 2. Perform user verification. The authenticator must provide two authentication factors within a single authenticator interaction.
>
> (å¼•ç”¨å…ƒ: https://simplewebauthn.dev/docs/advanced/passkeys#server)

ä»¥ä¸‹ã¯ã€(1) PublicKeyCredentialCreationOptions ã«é–¢ã™ã‚‹è¨­å®šã§ã™ã€‚ã“ã“ã§ã€``userVerification: 'preferred'`` ã‚’æŒ‡å®šã—ã¦ WebAuthn API ``navigator.credentials.create()`` å‘¼ã³å‡ºã—æ™‚ã« user verification ãŒå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã¾ãŸã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«å¿œã˜ã¦ ``authenticatorAttachment: 'cross-platform'`` ã‚’æŒ‡å®šã—ã¦ cross-device ã§ã®å‘¼ã³å‡ºã—ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

```js
import { generateRegistrationOptions } from '@simplewebauthn/server';

const options = await generateRegistrationOptions({
  // ...
  authenticatorSelection: {
    // "Discoverable credentials" used to be called "resident keys". The
    // old name persists in the options passed to `navigator.credentials.create()`.
    residentKey: 'required',
    userVerification: 'preferred',
    authenticatorAttachment: 'cross-platform'
  },
});
```

ä»¥ä¸‹ã¯ã€(6) server validation ã«é–¢ã™ã‚‹è¨­å®šã§ã™ã€‚ã“ã“ã§ã€attestationObject ã‹ã‚‰ user verification ãŒãŠã“ãªã‚ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```js
const verification = await verifyRegistrationResponse({
  // ...
  requireUserVerification: true,
});
```

ä¸Šè¨˜ã«ãŠã„ã¦ ``userVerification: 'preferred'`` ãŠã‚ˆã³ã€€``requireUserVerification: true,`` ã‚’æŒ‡å®šã™ã‚‹æ„å›³ã¨ã—ã¦ã¯ã€ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®é€šã‚Šã¨æƒ³å®šã—ã¦ã„ã¾ã™ã€‚ã“ã®ç‚¹ã«ã¤ã„ã¦ã¯å®Ÿéš›ã«åˆ©ç”¨ã‚’æƒ³å®šã™ã‚‹èªè¨¼å™¨ã«ã‚ˆã£ã¦ã¯ã€ä¾‹ãˆã° ``userVerification: 'required'`` ã®æŒ‡å®šã‚’æ¤œè¨ã™ã‚‹ä½™åœ°ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

> This guidance sets userVerification to preferred, meaning that user verification will be attempted when possible.
>  ... 
> When preferred is used, some platform authenticators will always require a user verification check when the device has biometric sensors, but may skip user verification on devices without them.
> ...
> The user verification result (conveyed in authenticator data flags) will reflect the actual user verification result and should always be validated against your requirements on the server.
> (å¼•ç”¨å…ƒ: https://passkeys.dev/docs/use-cases/bootstrapping/#a-note-about-user-verification)

æœ€å¾Œã«ã€èªè¨¼å™¨ãªã©ã«é–¢ã™ã‚‹æƒ…å ±ã‚’ user.id ãŠã‚ˆã³ RP ID ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ä»¥ä¸‹ã® WebAuthn ã®ä»•æ§˜ã®è¨˜è¼‰ã«ã‚‚ã¨ã¥ã„ãŸå‡¦ç†ã¨æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

> User Handle
> A user handle is an identifier for a user account, specified by the Relying Party as user.id during registration. Discoverable credentials store this identifier and MUST return it as response.userHandle in authentication ceremonies started with an empty allowCredentials argument.
> ...
> Authenticators map pairs of RP ID and user handle to public key credential sources
> (å¼•ç”¨å…ƒ: https://www.w3.org/TR/webauthn-3/#user-handle)

å¾Œè¿°ã® Conditional UI ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€èªè¨¼æ™‚ã® AuthenticatorAssertionResponse ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
Conditional UI ã‚’ä½¿ç”¨ã™ã‚‹éš›ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®å…¥åŠ›ãŒè¡Œã‚ã‚Œãªã„ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãªã©ã¯é›£ã—ã„ã§ã™ã€‚ä¸€æ–¹ã§ã€ä»£ã‚ã‚Šã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« userHandle ãŒå«ã¾ã‚Œã‚‹ãŸã‚ã€ã“ã¡ã‚‰ã‚’ã‚‚ã¨ã«å¿…è¦ãªæƒ…å ±ã‚’å–å¾—ã—ã¦å‡¦ç†ã‚’ãŠã“ãªã†ã“ã¨ãŒã§ãã‚‹ã“ã¨ã‚’ç¤ºå”†ã—ãŸè¨˜è¿°ã¨æ¨æ¸¬ã—ã¦ã„ã¾ã™ã€‚

```js:AuthenticatorAssertionResponse
{
  id: 'LEoFhr5eD-W7TmlnMm-6ixWLs2o',
  rawId: 'LEoFhr5eD-W7TmlnMm-6ixWLs2o',
  response: {
    authenticatorData: 'SZYN5Y...',
    clientDataJSON: 'eyJ0eXBlI...',
    signature: 'MEUCIE...',
    userHandle: 'eae45430d06c51aaa59dcbc9f6f884b2b6fdc1d5ae46433182fcd3ef2c538388'
  },
  type: 'public-key',
  clientExtensionResults: {},
  authenticatorAttachment: 'platform'
}
```

ä¸€æ–¹ã§ã€``id`` ã‚„ ``rawId`` ã¨ã„ã£ãŸå…¬é–‹éµã® ID ã‚’ç¤ºã™å€¤ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œã¦ãŠã‚Šã€ã“ã“ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã‹ã¨æ€ã†ã®ã§ã€ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒæ–¹æ³•ã«ã¤ã„ã¦ã¯ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«ã‚ˆã£ã¦åˆ¥é€”è€ƒæ…®ã™ã‚‹ä½™åœ°ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

### RP JavaScript Application

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã®ä»¥ä¸‹ã®é€šã‚Šã€ãƒ–ãƒ©ã‚¦ã‚¶å´ã§ç‰¹åˆ¥ãªå‡¦ç†ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚

> There isn't a whole lot that changes in how you call the browser methods if you want to support passkeys, as passkeys don't involve any changes in how WebAuthn is ultimately invoked.
>
> startRegistration()
> No changes are required.
> (å¼•ç”¨å…ƒ: https://simplewebauthn.dev/docs/advanced/passkeys#startregistration)

## èªè¨¼

æ¬¡ã®å›³ã«ã‚‚ã¨ã¥ã„ã¦èªè¨¼å‡¦ç†ã‚’èª¬æ˜ã—ã¾ã™ã€‚

![Authentication Flow](/images/129ae1819296dd/webauthn-authentication-flow-01.png)
_Authentication Flow[^4]_

### Relying Party Server

SimpleWebAuthn ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã®ä»¥ä¸‹ã®ç‚¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

> 2. Perform user verification. The authenticator must provide two authentication factors within a single authenticator interaction.
> (å¼•ç”¨å…ƒ: https://simplewebauthn.dev/docs/advanced/passkeys#server)

ä»¥ä¸‹ã¯ã€(1) PublicKeyCredentialRequestOptions ã«é–¢ã™ã‚‹è¨­å®šã§ã™ã€‚ã“ã“ã§ã€``userVerification: 'preferred'`` ã‚’æŒ‡å®šã—ã¦ WebAuthn API ``navigator.credentials.get()`` å‘¼ã³å‡ºã—æ™‚ã« user verification ãŒå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```js
const options = await generateAuthenticationOptions({
  // ...
  userVerification: 'preferred',
});
```

ä¸Šè¨˜ã§ ``preferred`` ã‚’æŒ‡å®šã™ã‚‹ç†ç”±ã«ã¤ã„ã¦ã¯æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

>  A note about user verification #
> This guidance sets userVerification to preferred, meaning that user verification will be attempted when possible.
> (å¼•ç”¨å…ƒ: https://passkeys.dev/docs/use-cases/bootstrapping/#a-note-about-user-verification)

ä»¥ä¸‹ã¯ã€(6) server validation ã«é–¢ã™ã‚‹è¨­å®šã§ã™ã€‚ã“ã“ã§ã€authenticatorData ã‹ã‚‰ user verification ãŒãŠã“ãªã‚ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```js
const authVerify = await verifyAuthenticationResponse({
  // ...
  requireUserVerification: true,
});
```

ä¸Šè¨˜ã®è¨­å®šã«ã¤ã„ã¦ã‚‚ã€passkesy.dev[^4] ã«ã¦è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ä»¥ä¸‹ã®å†…å®¹ã‚’æ„å›³ã—ãŸè¨­å®šã¨æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

> This guidance sets userVerification to preferred, meaning that user verification will be attempted when possible.
> (å¼•ç”¨å…ƒ: https://passkeys.dev/docs/use-cases/bootstrapping/#a-note-about-user-verification)

### RP JavaScript Application

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã®ä»¥ä¸‹ã®é€šã‚Šã€é€šå¸¸ã€ãƒ–ãƒ©ã‚¦ã‚¶å´ã§ç‰¹åˆ¥ãªå‡¦ç†ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚ä¸€æ–¹ã§ã€Conditional UI ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€è¿½åŠ ã§ã„ãã¤ã‹ã®å®Ÿè£…ã®èª¿æ•´ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

> There isn't a whole lot that changes in how you call the browser methods if you want to support passkeys, as passkeys don't involve any changes in how WebAuthn is ultimately invoked.
> ...
> startAuthentication()
> No changes are required.
> (å¼•ç”¨å…ƒ: https://simplewebauthn.dev/docs/advanced/passkeys#startregistration)

Conditional UI ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã®ä¸€èˆ¬çš„ãªæ‰‹é †ã«ã¤ã„ã¦ã¯ ``passkeys.dev`` ã‹ã‚‰ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã€ä»¥ä¸‹ã®é€šã‚Šã«ãªã‚Šã¾ã™ã€‚

> To support the autofill UI for passkeys, make sure to:
> 1. Add the username and webauthn value to any existing autocomplete annotations on the username input field as shown below in the example.
> 2. On page load, check to see if autofill UI (conditional mediation) is available using an if statement, then call navigator.credentials.get() with mediation: "conditional" and userVerification: "preferred".
> https://passkeys.dev/docs/use-cases/bootstrapping/

ã¾ãŸã€SimpleWebAuthn ã§ Conditional UI ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã®è¿½åŠ ã®æ‰‹é †ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://simplewebauthn.dev/docs/packages/browser#browser-autofill-aka-conditional-ui

ã¾ãšã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒ Conditional UI ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
SimpleWebAuthn ã§ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒ Conditional UI ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ ``browserSupportsWebAuthnAutofill()``ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

```js
import { browserSupportsWebAuthnAutofill } from '@simplewebauthn/browser';
```

ã¾ãŸã€``browserSupportsWebAuthnAutofill()`` ã¯ ``startAuthentication()`` ã®ç¬¬äºŒå¼•æ•°ã‚’ true ã«ã™ã‚‹ã“ã¨ã§è‡ªå‹•ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

> This method is automatically called by startAuthentication() when true is passed as a second argument, but it may still be independently useful in, for example, single-page applications that may seek to initiate authentication after page load.
> (å¼•ç”¨å…ƒ: https://simplewebauthn.dev/docs/packages/browser#browser-autofill-aka-conditional-ui)

ä¸Šè¨˜ã‚’è¸ã¾ãˆã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã« ``startAuthentication()`` ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ Conditional UI ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãªãŠã€ã“ã“ã§ã¯ ``startAuthentication()`` ã‚’ã‚¯ãƒªãƒƒã‚¯ãƒ™ãƒ³ãƒˆã§ã¯ãªãã€ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚‹ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ 

```js
<head>
  <!-- ... -->
  <script>
    const { startAuthentication } = SimpleWebAuthnBrowser;

    fetch('/assertion/options')
      .then((options) => {
        // Note the `true` argument here
        startAuthentication(options, true)
          .then(async asseResp => {
            const verificationResp = await fetch('/assertion/result', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(asseResp),
            });
            const verificationJSON = await verificationResp.json();
            if (verificationJSON && verificationJSON.status === 'ok') {
              ...
            }
            ...
          })
          .catch(err => handleError);
      });
  </script>
</head>
<body>
  <!-- ... -->
  <label for="username">Username</label>
  <input type="text" name="username" autocomplete="webauthn">
```

## å‹•ä½œç¢ºèª

ä»Šå›å®Ÿè£…ã—ãŸã‚µãƒ³ãƒ—ãƒ«ã¯ä»¥ä¸‹ã®æ‰‹é †ã§å‹•ä½œç¢ºèªã§ãã¾ã™ã€‚

```sh
$ git clone https://github.com/kg0r0/simplewebauthn-example.git
$ cd simplewebauthn-example 
$ git checkout passkeys
$ npm install
$ npm start
```

ã¾ãšã¯ ``http://localhost:3000`` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦èªè¨¼å™¨ã®ç™»éŒ²ã‚’é€²ã‚ã¾ã™ã€‚

![Registration Flow](/images/129ae1819296dd/autofill-registration-01.png)

ã“ã“ã§ã€``authenticatorAttachment: 'cross-platform'`` ã‚’æŒ‡å®šã—ã¦ã„ãŸå ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ã« QR ã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![Registration Flow](/images/129ae1819296dd/autofill-registration-02.png)

ä»¥ä¸‹ã®é€šã‚Šç™»éŒ²ãŒå®Œäº†ã—ãŸã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚

![Registration Flow](/images/129ae1819296dd/autofill-registration-03.png)

æ¬¡ã«  Conditional UI ã‚’ä½¿ç”¨ã™ã‚‹ HTML ãŒè¡¨ç¤ºã•ã‚Œã‚‹ ``http://localhost:3000/login`` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦èªè¨¼ã‚’é€²ã‚ã¾ã™ã€‚
å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’åˆã‚ã›ã‚‹ã“ã¨ã§éå»ã«ç”Ÿæˆã—ãŸ Passkey ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã“ã§ã€å…ˆã»ã©ç™»éŒ²ã—ãŸ TEST8 ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![Authentication Flow](/images/129ae1819296dd/autofill-authentication-01.png)

Passkey ã‚’é¸æŠã—ãŸå¾Œã€ä»¥ä¸‹ã®ã‚ˆã†ã« user verification ãŒè¦æ±‚ã•ã‚Œã¾ã™ã€‚

![Authentication Flow](/images/129ae1819296dd/autofill-authentication-02.png)

æ¬¡ã®é€šã‚Šã€TEST8 ã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦èªè¨¼ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

![Authentication Flow](/images/129ae1819296dd/autofill-authentication-03.png)

## ã¾ã¨ã‚

æœ¬æŠ•ç¨¿ã§ã¯ã€SimpleWebAuthn ã‚’ä½¿ç”¨ã—ã¦å®Ÿè£…ã—ãŸ WebAuthn ã® RP ã§ Passkeys ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹æ–¹æ³•ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚
Conditional UI ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ã¾ã§è€ƒæ…®ã—ãŸå ´åˆã€WebAuth ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãªã©ã ã‘ã§ãªãã€Relying Party Server ã«ãŠã‘ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ä¿ç®¡æ–¹æ³•ã‚„ã€RP JavaScript Application ã«ãŠã‘ã‚‹ API ã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ãªã©ã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨æ„Ÿã˜ã¾ã—ãŸã€‚

ã§ã¯ã¾ãŸï¼

[^1]: SimpleWebAuthn | Introduction https://simplewebauthn.dev/docs/
[^2]: FIDO Alliance | Passkeys https://fidoalliance.org/passkeys/
[^3]: Web Authentication: An API for accessing Public Key Credentials Level 3 | 5. Web Authentication API https://www.w3.org/TR/webauthn-3/#sctn-api
[^4]: passkeys.dev https://passkeys.dev/
[^5]: SimpleWebAuthn | Advanced Guides | Passkeys https://simplewebauthn.dev/docs/advanced/passkeys
[^6]: Browser | startAuthentication() | Browser autofill, a.k.a. Conditional UI https://simplewebauthn.dev/docs/packages/browser#browser-autofill-aka-conditional-ui