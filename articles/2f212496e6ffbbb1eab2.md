---
title: "SPIREã®Quickstart for KubernetesãŸã‚ã™"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["spiffe", "spire"]
published: true 
---
[Quickstart for Kubernetes](https://spiffe.io/docs/latest/try/getting-started-k8s/)ã‚’è©¦ã—ã¦ã¿ãŸã®ã§ãã®æ™‚ã®ãƒ¡ãƒ¢ã‚’æ®‹ã™ã€‚
ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã§SPIRE Serverã¨SPIRE Agentã‚’å®Ÿè¡Œã—ã€SPIREã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã‚’è¨­å®šã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã•ã‚Œã¦ã„ã‚‹ã€‚
## Obtain the Required Files
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹ã€‚
```
$ git clone https://github.com/spiffe/spire-tutorials.git
$ cd spire-tutorials/k8s/quickstart/
```

## Configure Kubernetes Namespace for SPIRE Components
SPIRE ServerãŠã‚ˆã³SPIRE AgentãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹Namespaceã‚’æ§‹æˆã™ã‚‹ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦Namespaceã‚’ä½œæˆã™ã‚‹ã€‚
```
$ kubectl apply -f spire-namespace.yaml
namespace/spire created
```
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦``spire`` NamespaceãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
```
$ kubectl get namespaces
NAME              STATUS   AGE
default           Active   32h
kube-node-lease   Active   32h
kube-public       Active   32h
kube-system       Active   32h
spire             Active   32h
```

## Configure SPIRE Server
### Create Server Bundle Configmap, Role & ClusterRoleBinding
SPIRE ServerãŒæ©Ÿèƒ½ã™ã‚‹ãŸã‚ã«ã¯ã€SPIRE Agentã«è¨¼æ˜æ›¸ã‚’æä¾›ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ã“ã®è¨¼æ˜æ›¸ã¯ã€SPIRE AgentãŒæ¥ç¶šã‚’ç¢ºç«‹ã™ã‚‹éš›ã«SPIRE ServerãŒèº«å…ƒã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ã€‚
SPIRE Agentã¨SPIRE ServerãŒåŒã˜ã‚¯ãƒ©ã‚¹ã‚¿ã«å­˜åœ¨ã—ã¦ã„ã‚‹å ´åˆã€SPIREã¯å®šæœŸçš„ã«è¨¼æ˜æ›¸ã‚’è‡ªå‹•ç”Ÿæˆã—ã€è¨¼æ˜æ›¸ã®å†…å®¹ã‚’ConfigMapã«æ›´æ–°ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ãã®ãŸã‚ã«ã¯ã€SPIRE Serverã¯spire Namespaceã®ConfigMapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã—ãŸã‚Šã€ãƒ‘ãƒƒãƒã‚’å½“ã¦ãŸã‚Šã™ã‚‹æ©Ÿèƒ½ãŒå¿…è¦ã«ãªã‚‹ã€‚
SPIRE ServerãŒConfigMapãŠèª­ã¿æ›¸ãã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã«ã¯ã€Kubernetesã®RBACã«é©åˆ‡ãªæ¨©é™ã‚’ä¸ãˆã‚‹ClusterRoleã‚’ä½œæˆã—ã€ãã®ClusterRoleBindingã‚’ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«é–¢é€£ã¥ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€SPIRE Serverã®ServiceAccountã€ConfigMapã€RoleBindingã‚’ä½œæˆã™ã‚‹ã€‚
```
$ kubectl apply \
    -f server-account.yaml \
    -f spire-bundle-configmap.yaml \
    -f server-cluster-role.yaml
serviceaccount/spire-server created
configmap/spire-bundle created
clusterrole.rbac.authorization.k8s.io/spire-server-trust-role created
clusterrolebinding.rbac.authorization.k8s.io/spire-server-trust-role-binding created
```

### Create Server Configmap
SPIRE Serverã¯server-configmap.yamlã§æŒ‡å®šã•ã‚ŒãŸKubernetesã®Configmapã§è¨­å®šã•ã‚Œã‚‹ã€‚ã“ã®Configmapã«ã¯ã€``/run/spire/data``ã¨``/run/spire/config``ã¨ã„ã£ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæŒ‡å®šã•ã‚Œã‚‹ã€‚ã“ã‚Œã‚‰ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«é…ç½®ã•ã‚Œã‚‹ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€Configmapã¨Statefulsetã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚
```
$ kubectl apply \
    -f server-configmap.yaml \
    -f server-statefulset.yaml \
    -f server-service.yaml
configmap/spire-server created
statefulset.apps/spire-server created
service/spire-server created
```
ã“ã‚Œã«ã‚ˆã‚Šã€``spire`` Namespaceã«``spire-server``ã¨ã„ã†StatefulSetãŒä½œæˆã•ã‚Œã€spire-server PodãŒèµ·å‹•ã™ã‚‹ã€‚
```
$ kubectl get statefulset --namespace spire
NAME           READY   AGE
spire-server   1/1     6m25s

$ kubectl get pods --namespace spire
NAME             READY   STATUS              RESTARTS   AGE
spire-server-0   0/1     ContainerCreating   0          22s

$ kubectl get services --namespace spire
NAME           TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
spire-server   NodePort   10.100.74.158   <none>        8081:30400/TCP   8m42s
```

## Configure and deploy the SPIRE Agent
SPIRE AgentãŒWorkload Attestationã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®kubelet APIã¸ã®èª­ã¿å–ã‚Šã‚’è¨±å¯ã™ã‚‹ã«ã¯ã€Kubernetes RBACã«é©åˆ‡ãªæ¨©é™ã‚’ä»˜ä¸ã™ã‚‹Service Accountã¨Cluster Roleã‚’ä½œæˆã—ã€ãã®ClusterRoleBindingã‚’Service Accountã«é–¢é€£ã¥ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
```
$ kubectl apply \
    -f agent-account.yaml \
    -f agent-cluster-role.yaml
serviceaccount/spire-agent created
clusterrole.rbac.authorization.k8s.io/spire-agent-cluster-role created
clusterrolebinding.rbac.authorization.k8s.io/spire-agent-cluster-role-binding created
```
agent-configmap.yamlã§SPIRE Agentã®Configmapã‚’ä½œæˆã—ã€å„Kubernetes Worker Nodeã§å„Agentã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚’1ã¤ãšã¤å®Ÿè¡Œã™ã‚‹DaemonSetã¨ã—ã¦Agentã‚’å±•é–‹ã™ã‚‹ã€‚
```
$ kubectl apply \
    -f agent-configmap.yaml \
    -f agent-daemonset.yaml
configmap/spire-agent created
daemonset.apps/spire-agent created
```
ã“ã‚Œã«ã‚ˆã‚Šã€spire Namespaceã«spire agentã¨ã„ã†DaemonSetãŒä½œæˆã•ã‚Œã€spire-serverã¨å…±ã«spire-agent PodãŒèµ·å‹•ã™ã‚‹ã€‚
```
$ kubectl get daemonset --namespace spire
NAME          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
spire-agent   1         1         1       1            1           <none>          108s

$ kubectl get pods --namespace spire
NAME                READY   STATUS    RESTARTS   AGE
spire-agent-bxh6n   1/1     Running   0          3m8s
spire-server-0      1/1     Running   0          16m
```
DaemonSetã¨ã—ã¦ã€ãƒãƒ¼ãƒ‰æ•°ã¨åŒã˜æ•°ã®spire-agent PodãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚

## Register Workloads
SPIREãŒWorkloadã®èªè¨¼ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã¯ã€Workloadã‚’SPIRE Serverã«ç™»éŒ²ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Workloadã‚’ã©ã®ã‚ˆã†ã«è­˜åˆ¥ã™ã‚‹ã‹ã€ã©ã®SPIFFE IDã‚’ä¸ãˆã‚‹ã‹ã‚’SPIREã«ä¼ãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
1. Nodeã«å‰²ã‚Šå½“ã¦ã‚‹SPIFFE IDã‚’æŒ‡å®šã—ã€Nodeã®æ–°è¦ç™»éŒ²ã‚¨ãƒ³ãƒˆãƒªã‚’ä½œæˆã™ã‚‹ã€‚
```
$  kubectl exec -n spire spire-server-0 -- \
    /opt/spire/bin/spire-server entry create \
    -spiffeID spiffe://example.org/ns/spire/sa/spire-agent \
    -selector k8s_sat:cluster:demo-cluster \
    -selector k8s_sat:agent_ns:spire \
    -selector k8s_sat:agent_sa:spire-agent \
    -node
Entry ID         : cee5d6e5-1667-4be3-8c78-7c61e3d95fdd
SPIFFE ID        : spiffe://example.org/ns/spire/sa/spire-agent
Parent ID        : spiffe://example.org/spire/server
Revision         : 0
TTL              : default
Selector         : k8s_sat:agent_ns:spire
Selector         : k8s_sat:agent_sa:spire-agent
Selector         : k8s_sat:cluster:demo-cluster

```
2. ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã«å‰²ã‚Šå½“ã¦ã‚‹SPIFFE IDã‚’æŒ‡å®šã—ã¦ã€ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã®æ–°ç™»éŒ²ã‚¨ãƒ³ãƒˆãƒªã‚’ä½œæˆã™ã‚‹ã€‚
```
$ kubectl exec -n spire spire-server-0 -- \
    /opt/spire/bin/spire-server entry create \
    -spiffeID spiffe://example.org/ns/default/sa/default \
    -parentID spiffe://example.org/ns/spire/sa/spire-agent \
    -selector k8s:ns:default \
    -selector k8s:sa:default
Entry ID         : 59bda4d3-a1fd-4ba5-b5a5-71a07b92370b
SPIFFE ID        : spiffe://example.org/ns/default/sa/default
Parent ID        : spiffe://example.org/ns/spire/sa/spire-agent
Revision         : 0
TTL              : default
Selector         : k8s:ns:default
Selector         : k8s:sa:default
```

## Configure a Workload Container to Access SPIRE
Workloadã‚³ãƒ³ãƒ†ãƒŠãŒSPIREã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã€‚å…·ä½“çš„ã«ã¯ã€Workload API UNIXãƒ‰ãƒ¡ã‚¤ãƒ³ã‚½ã‚±ãƒƒãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚ˆã†ã«Workloadã‚³ãƒ³ãƒ†ãƒŠã‚’è¨­å®šã™ã‚‹ã€‚
client-deploymentãƒ•ã‚¡ã‚¤ãƒ«ã¯Serverã¨Agentã«ä½¿ç”¨ã•ã‚Œã‚‹spire-k8s Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦no-opã‚³ãƒ³ãƒ†ãƒŠã‚’æ§‹æˆã™ã‚‹ã€‚
1. deploymentãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©ç”¨ã™ã‚‹ã€‚
```
$ kubectl apply -f client-deployment.yaml
deployment.apps/client created
```
2. å®Ÿè¡Œä¸­ã®Podã¸ã®ã‚·ã‚§ãƒ«æ¥ç¶šã‚’é–‹å§‹ã™ã‚‹ã€‚
```
$ kubectl exec -it $(kubectl get pods -o=jsonpath='{.items[0].metadata.name}' \
   -l app=client)  -- /bin/sh
/opt/spire #
```
3. æ¥ç¶šå¾Œã€ã‚³ãƒ³ãƒ†ãƒŠãŒã‚½ã‚±ãƒƒãƒˆã«æ¥ç¶šã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
```
/opt/spire #  /opt/spire/bin/spire-agent api fetch -socketPath /run/spire/sockets/agent.sock
Received 1 svid after 100.376685ms

SPIFFE ID:		spiffe://example.org/ns/default/sa/default
SVID Valid After:	2021-06-10 16:37:29 +0000 UTC
SVID Valid Until:	2021-06-10 17:37:39 +0000 UTC
CA #1 Valid After:	2021-06-10 16:19:14 +0000 UTC
CA #1 Valid Until:	2021-06-11 16:19:24 +0000 UTC

/opt/spire #
```

## Tear Down All Components
1. Workloadã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤ã™ã‚‹ã€‚
```
$ kubectl delete deployment client
deployment.apps "client" deleted
```
2. ã™ã¹ã¦ã®Agentã€ServerãŠã‚ˆã³Deploymentã¨è¨­å®šã‚’å‰Šé™¤ã™ã‚‹ã€‚
```
$ kubectl delete namespace spire
namespace "spire" deleted
```
3. ClusterRoleãŠã‚ˆã³ClusterRoleBindingè¨­å®šã‚’å‰Šé™¤ã™ã‚‹ã€‚
```
$ kubectl delete clusterrole spire-server-trust-role spire-agent-cluster-role
clusterrole.rbac.authorization.k8s.io "spire-server-trust-role" deleted
clusterrole.rbac.authorization.k8s.io "spire-agent-cluster-role" deleted

$ kubectl delete clusterrolebinding spire-server-trust-role-binding spire-agent-cluster-role-binding
clusterrolebinding.rbac.authorization.k8s.io "spire-server-trust-role-binding" deleted
clusterrolebinding.rbac.authorization.k8s.io "spire-agent-cluster-role-binding" deleted
```

## References
- https://spiffe.io/docs/latest/try/getting-started-k8s/