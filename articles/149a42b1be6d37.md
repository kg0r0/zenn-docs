---
title: "Okta ã® AMR claim ã‚’çœºã‚ã¦ã¿ãŸ"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Okta", "OIDC"]
published: true
---

Okta ãŒ Authentication Method Reference (AMR) ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‚ˆã†ã ã£ãŸã®ã§[^1]ã€ã›ã£ã‹ããªã®ã§è©¦ã—ã¦ã¿ã¦å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¦ãŠãã¾ã™ã€‚
AMR ã«ã¤ã„ã¦ã¯ã€RFC 8176 Authentication Method Reference Values[^2] ã‚„ OpenID Connect (OIDC) ã® amr ã‚¯ãƒ¬ãƒ¼ãƒ ã®èª¬æ˜[^3]ã‚‚ä½µã›ã¦ç¢ºèªã™ã‚‹ã¨è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

Okta ã® AMR å®Ÿè£…ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ[^1]ã«è¨˜è¼‰ãŒã‚ã‚Šã¾ã—ãŸã€‚

https://developer.okta.com/docs/guides/configure-amr-claims-mapping/main/

ä¸Šè¨˜ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯å¤–éƒ¨ IdP ã‹ã‚‰ AMR ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’å—ã‘å–ã‚‹å ´åˆã®ãƒ•ãƒ­ãƒ¼ã‚„è¨­å®šãªã©ãŒè‰²ã€…è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ãŒã€ä»¥ä¸‹ã®é€šã‚Šå˜ç´”ã« Okta ã‹ã‚‰ç™ºè¡Œã•ã‚Œã‚‹ ID Token ã« amr ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’å«ã‚ã‚‹ã ã‘ã§ã‚ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¡Œã‚ã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚

> Custom OpenID Connect apps
> If you're using a custom OpenID Connect app in the Okta IdP org, amr claims are sent to the SP by default and no additional configuration is required.
> (å¼•ç”¨å…ƒ: https://developer.okta.com/docs/guides/configure-amr-claims-mapping/main/#custom-openid-connect-apps)

ã•ã£ããè©¦ã—ã¦ã¿ã¾ã™ãŒã€ã“ã“ã§ã¯ Okta ã«ãŠã‘ã‚‹ OIDC RP ã‚„ MFA ã®è¨­å®šæ–¹æ³•ã®è©³ç´°ã«ã¤ã„ã¦ã¯å‰²æ„›ã—ã¾ã™ã€‚

ã¾ãšã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãª Authentication Request ã®ã€€URL ã‹ã‚‰ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ã—ã¾ã™ã€‚

```bash
https://<Okta domain>/oauth2/default/v1/authorize?response_type=code&client_id=<Client ID>&redirect_uri=http://localhost:8080/login/callback&scope=openid offline_access&state=abc&code_challenge=E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM&code_challenge_method=s256
```

Username ãŠã‚ˆã³ Password ã®å…¥åŠ›ãŒè¦æ±‚ã•ã‚Œã‚‹ã®ã§ã€å…¥åŠ›å¾Œã« [Sign In] ã‚’æŠ¼ä¸‹ã—ã¾ã™ã€‚

![](/images/149a42b1be6d37/pw.png)

Authorization Code ãŒå–å¾—ã§ãã‚‹ãŸã‚ã€ä»¥ä¸‹ã®é€šã‚Šã€€Token Request ã«ã‚ˆã£ã¦ ID Token ã‚’å–å¾—ã—ã¾ã™ã€‚

```bash
$ curl -i --request POST \
       --url 'https://<Okta Domain>/oauth2/default/v1/token' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/x-www-form-urlencoded' \
       --data 'grant_type=authorization_code' \
       --data 'redirect_uri=http://localhost:8080/login/callback' \
       --data 'code=<Authorization Code>' \
       --data 'code_verifier=dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk' \
       --data 'client_id=<Client ID>'

{"token_type":"Bearer","expires_in":3600,"access_token":"eyJ...","scope":"openid","id_token":"eyJ..."}
```

ã“ã®ã¨ãã® ID Token ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœã¯ä»¥ä¸‹ã®é€šã‚Šã§ã—ãŸã€‚

![](/images/149a42b1be6d37/id_token.png)
*ID Token*

Username / Password ã«ã‚ˆã‚‹èªè¨¼ã‚’ãŠã“ãªã£ãŸãŸã‚ amr ã‚¯ãƒ¬ãƒ¼ãƒ ã®é…åˆ—ã¨ã—ã¦ pwd ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

>   pwd
>      Password-based authentication [RFC4949].
> (å¼•ç”¨å…ƒ: https://www.rfc-editor.org/rfc/rfc8176.html#section-2) 

æ¬¡ã« MFA ã‚’æœ‰åŠ¹ã«ã—ã¦ã¿ã¾ã™ã€‚

![](/images/149a42b1be6d37/mfa.png)

Username / Password ã«ã‚ˆã‚‹èªè¨¼ã‚’è¡Œã£ãŸã®ã¡ã« FIDO2 (WebAuthn) ã‚’ä½¿ç”¨ã—ãŸ MFA ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚

![](/images/149a42b1be6d37/passkey.png)

ã“ã®ã¨ãã® ID Token ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœã¯ä»¥ä¸‹ã®é€šã‚Šã§ã—ãŸã€‚

![](/images/149a42b1be6d37/id_token_2.png)

amr ã‚¯ãƒ¬ãƒ¼ãƒ ã®é…åˆ—ã¨ã—ã¦ pwdã€swkã€mfa ãŒå«ã¾ã‚Œã¦ã„ã¾ã—ãŸã€‚

>   pwd
>      Password-based authentication [RFC4949].
>
>   mfa
>      Multiple-factor authentication [NIST.800-63-2] [ISO29115].  When
>      this is present, specific authentication methods used may also be
>      included.
>
>    swk
>      Proof-of-Possession (PoP) of a software-secured key.  See
>      Appendix C of [RFC4211] for a discussion on PoP.
>
> (å¼•ç”¨å…ƒ: https://www.rfc-editor.org/rfc/rfc8176.html#section-2) 

MFA ã¨ã—ã¦ FIDO2 (WebAuthn) ã‚’ä½¿ç”¨ã—ãŸã®ã§ã€hwk ãŒå«ã¾ã‚Œã‚‹ã‚ˆã†ãªæ°—ãŒã—ã¦ã„ã¾ã—ãŸãŒå®Ÿéš›ã«ã¯ swk ã§ã—ãŸã€‚
å¿µã®ç‚ºã€€Authenticator ã¨ã—ã¦ YubiKey ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã‚‚ãŸã‚ã—ã¦ã¿ã¾ã™ã€‚
![](/images/149a42b1be6d37/yubikey.png)

ã“ã®ã¨ãã® ID Token ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœã¯ä»¥ä¸‹ã®é€šã‚Š hwk ãŒå«ã¾ã‚Œã¦ã„ã¾ã—ãŸã€‚

![](/images/149a42b1be6d37/id_token_3.png)

YubiKey ã¯å•é¡Œãªã Authenticator ã¨ã—ã¦ç™»éŒ²ã§ãã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

![](/images/149a42b1be6d37/config.png)

ä¸€å¿œ amr ã‚¯ãƒ¬ãƒ¼ãƒ ã«ã¤ã„ã¦ã¯éå»ã®ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã«è¨˜è¼‰ãŒã‚ã‚Šã¾ã—ãŸ[^4]ã€‚

> New Values for amr Base Claim
> We improved some behaviors related for base claim amr:
> ãƒ»When MFA factors sms or call are used, the amr claim returns mca (opens new window).
> ãƒ»When MFA factor token:hardware is used, the amr claim returns hwk.
> ãƒ»When MFA factor web is used, the amr claim returns swk.
>
> (å¼•ç”¨å…ƒ: https://developer.okta.com/docs/release-notes/2017/#strict-policy-enforcement-for-password-changes)

ã‚ã¨ã¯ RFC 4211 ã® Appendix C[^5] ã®è¨˜è¿°ã¨ã‹ã‚‚æ°—ã«ãªã‚Šã¾ã™ã€‚

>   hwk
>      Proof-of-Possession (PoP) of a hardware-secured key.  See
>      Appendix C of [RFC4211] for a discussion on PoP.
>
>    swk
>      Proof-of-Possession (PoP) of a software-secured key.  See
>      Appendix C of [RFC4211] for a discussion on PoP.
>
> (å¼•ç”¨å…ƒ: https://www.rfc-editor.org/rfc/rfc8176.html#section-2) 

ä»Šå›ã¯ã‚ãã¾ã§è©¦ã—ã¦ã¿ãŸã ã‘ã®å‚™å¿˜éŒ²ãªã®ã§ã“ã“ã‚‰è¾ºã§çµ‚ã‚ã‚Šã¾ã™ã€‚
æ°—ãŒå‘ã„ãŸã‚‰ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã® ACR ã‚‚è©¦ã—ã¦ã¿ã‚ˆã†ã‹ã¨æ€ã„ã¾ã™ã€‚

https://developer.okta.com/docs/guides/step-up-authentication/main/

ã§ã¯ã¾ãŸï¼

[^1]: Configure AMR claims mapping https://developer.okta.com/docs/guides/step-up-authentication/main/
[^2]: Authentication Method Reference Values https://www.rfc-editor.org/rfc/rfc8176.html
[^3]: OpenID Connect Core 1.0 incorporating errata set 2 | 2.  ID Token https://openid.net/specs/openid-connect-core-1_0.html#IDToken
[^4]: okta Developer Release Notes 2017 https://developer.okta.com/docs/release-notes/2017/#strict-policy-enforcement-for-password-changes
[^5]: Internet X.509 Public Key Infrastructure Certificate Request Message Format (CRMF) | Appendix C.  Why do Proof-of-Possession (POP) https://www.rfc-editor.org/rfc/rfc4211#appendix-C