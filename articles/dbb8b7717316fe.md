---
title: "Okta ã® Authentication Context Class Reference (acr) ã®å®Ÿè£…ã‚’çœºã‚ã¦ã¿ãŸ"
emoji: "ğŸ“š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["OIDC", "OAuth", "Okta"]
published: true 
---

## ã¯ã˜ã‚ã«

Okta ãŒ Authentication Context Class Reference (ACR) ã«å¯¾å¿œã—ã¦ã„ã‚‹ã‚ˆã†ã ã£ãŸã®ã§[^1]ã€ã›ã£ã‹ããªã®ã§è©¦ã—ã¦ã¿ã¦å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¦ãŠãã¾ã™ã€‚

https://developer.okta.com/docs/guides/step-up-authentication/main/

ACR ã®èª¬æ˜ã«ã¤ã„ã¦ã¯ã€€OpenID Connect Core[^2] ãªã©ã‹ã‚‰ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

> acr
> OPTIONAL. Authentication Context Class Reference. String specifying an Authentication Context Class Reference value that identifies the Authentication Context Class that the authentication performed satisfied. 
> (å‚è€ƒ: https://openid.net/specs/openid-connect-core-1_0.html#IDToken)

ä¾‹ãˆã°ã€Okta ã§ã¯ ACR value ã‚’ä½¿ç”¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ•ãƒ­ãƒ¼ã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã§ã™ã€‚

![](/images/dbb8b7717316fe/step-up-authentication-acr-flow.png)
*Authentication flow using ACR values[^1]*

Okta ã¯ ``acr_values`` ã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªå€¤ã‚’äº‹å‰å®šç¾©ã—ã¦ãŠã‚Šã€1FA ã‚„ 2FA ãªã©ã®æŒ‡å®šãŒã§ãã‚‹ã‚ˆã†ã§ã™ã€‚
ã¾ãŸã€``phr``ã€``phrh`` ã¨ã„ã£ãŸ OpenID Connect Extended Authentication Profile (EAP) ACR Values 1.0[^3] ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹å€¤ã«ã¤ã„ã¦ã‚‚è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ã€‚

![](/images/dbb8b7717316fe/predefined_parameter_values.png)

## å‹•ä½œç¢ºèª

### 1FA

ã¾ãšã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã« ``arc_values`` ã¨ã—ã¦ ``urn:okta:loa:1fa:any`` ã¨ã„ã†å€¤ã‚’æŒ‡å®šã—ãŸ Autorization Request ã‚’ãŠã“ãªã„ã¾ã™ã€‚

```bash
https://${yourOktaDomain}/oauth2/default/v1/authorize?client_id={clientId}
&response_type=code
&scope=openid
&redirect_uri=https://${yourOktaDomain}/authorization-code/callback
&state=296bc9a0-a2a2-4a57-be1a-d0e2fd9bb601
&acr_values=urn:okta:loa:1fa:any
```

Username ãŠã‚ˆã³ Password ã«ã‚ˆã‚‹èªè¨¼ã®ã¿ãŒè¦æ±‚ã•ã‚Œã€èªè¨¼ãŒæˆåŠŸã™ã‚‹ã¨ã€€Authorization Code ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚

![](/images/dbb8b7717316fe/login_1fa.png =400x)

å–å¾—ã—ãŸ Authorization Code ãªã©ã‚’ä½¿ç”¨ã—ã¦ Token Request ã‚’ãŠã“ãªã„ã¾ã™ã€‚

```bash
$ curl -i  -u '<Client ID>:<Client Secret>' --request POST \
            --url 'https://${yourOktaDomain}/oauth2/default/v1/token' \
            --header 'Accept: application/json' \
            --header 'Content-Type: application/x-www-form-urlencoded' \
            --data 'grant_type=authorization_code' \
            --data 'redirect_uri=http://localhost:8080/authorization-code/callback' \
            --data 'code=<Authorization Code>'
...
{"token_type":"Bearer","expires_in":3600,"access_token":"eyJ...","scope":"openid","id_token":"eyJ..."}
```

å–å¾—ã—ãŸ Access Token ã‚’ã§ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœã¯ä»¥ä¸‹ã®é€šã‚Šã«ãªã£ã¦ã„ã¾ã—ãŸã€‚Authorization Request ã§æŒ‡å®šã—ãŸ acr ã®å€¤ãŒã‚¯ãƒ¬ãƒ¼ãƒ ã¨ã—ã¦å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

![](/images/dbb8b7717316fe/access_token_1fa.png)
*Access Token*

ID Token ã‚’ã§ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœã¯ä»¥ä¸‹ã®é€šã‚Šã«ãªã£ã¦ã„ã¾ã—ãŸã€‚ã“ã¡ã‚‰ã‚‚ Authorization Request ã§æŒ‡å®šã—ãŸã€€acr ã®å€¤ãŒã‚¯ãƒ¬ãƒ¼ãƒ ã¨ã—ã¦å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãŸã€amr ã‚¯ãƒ¬ãƒ¼ãƒ ã‚‚å«ã¾ã‚Œã¦ãŠã‚Šã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦èªè¨¼ãŒè¡Œã‚ã‚ŒãŸã“ã¨ãŒç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™[^4]ã€‚

![](/images/dbb8b7717316fe/id_token_1fa.png)
*ID Token*

### 2FA

æ¬¡ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã« ``acr_values`` ã¨ã—ã¦ ``urn:okta:loa:2fa:any`` ã¨ã„ã†å€¤ã‚’æŒ‡å®šã—ãŸ Authorization Request ã‚’ãŠã“ãªã„ã¾ã™ã€‚

```bash
https://${yourOktaDomain}/oauth2/default/v1/authorize?client_id={clientId}
&response_type=code
&scope=openid
&redirect_uri=https://${yourOktaDomain}/authorization-code/callback
&state=296bc9a0-a2a2-4a57-be1a-d0e2fd9bb601
&acr_values=urn:okta:loa:2fa:any
```

Username ãŠã‚ˆã³ã€€Password ã«ã‚ˆã‚‹èªè¨¼ãŒãŠã“ãªã‚ã‚ŒãŸå¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® MFA ã®è¨­å®šçŠ¶æ³ã«ã‚ˆã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªè¿½åŠ ã§ã®èªè¨¼ãŒè¦æ±‚ã•ã‚Œã¾ã™ã€‚

![](/images/dbb8b7717316fe/login_2fa.png =400x)

å–å¾—ã—ãŸ Authorization Code ãªã©ã‚’ä½¿ç”¨ã—ã¦ Token Request ã‚’ãŠã“ãªã„ã¾ã™ã€‚

```bash
$ curl -i  -u '<Client ID>:<Client Secret>' --request POST \
            --url 'https://${yourOktaDomain}/oauth2/default/v1/token' \
            --header 'Accept: application/json' \
            --header 'Content-Type: application/x-www-form-urlencoded' \
            --data 'grant_type=authorization_code' \
            --data 'redirect_uri=http://localhost:8080/authorization-code/callback' \
            --data 'code=<Authorization Code>'
...
{"token_type":"Bearer","expires_in":3600,"access_token":"eyJ...","scope":"openid","id_token":"eyJ..."}
```

å–å¾—ã—ãŸ Access Token ã‚’ã§ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœã¯ä»¥ä¸‹ã®é€šã‚Šã«ãªã£ã¦ã„ã¾ã—ãŸã€‚Authorization Request ã§æŒ‡å®šã—ãŸ acr ã®å€¤ãŒã‚¯ãƒ¬ãƒ¼ãƒ ã¨ã—ã¦å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

![](/images/dbb8b7717316fe/access_token_2fa.png)
*Access Token*

ID Token ã‚’ã§ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœã¯ä»¥ä¸‹ã®é€šã‚Šã«ãªã£ã¦ã„ã¾ã—ãŸã€‚ã“ã¡ã‚‰ã‚‚ Authorization Request ã§æŒ‡å®šã—ãŸã€€acr ã®å€¤ãŒã‚¯ãƒ¬ãƒ¼ãƒ ã¨ã—ã¦å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãŸã€amr ã‚¯ãƒ¬ãƒ¼ãƒ ã‚‚å«ã¾ã‚Œã¦ãŠã‚Šã€MFA ãŒè¡Œã‚ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™[^4]ã€‚

![](/images/dbb8b7717316fe/id_token_2fa.png)
*ID Token*

## ãŠã‚ã‚Šã«

ã–ã£ãã‚Šã¨ Okta ã® ACR ã®å®Ÿè£…ã«ã¤ã„ã¦çœºã‚ã¦ã¿ã¾ã—ãŸã€‚
ã¨ã‚Šã‚ãˆãšã€ä¸€èˆ¬çš„ãªã€€ACR ã®åˆ©ç”¨ç”¨é€”ã¨ã—ã¦ä½¿ç”¨ã§ããã†ã¨ã„ã†å°è±¡ã§ã—ãŸ (Okta Identity Engine ã§è©•ä¾¡ãƒ•ãƒ­ãƒ¼ãªã©ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒã§ããã†ã§ã™ãŒã€ä»Šå›ã¯ä¸€æ—¦ã‚¹ãƒ«ãƒ¼ã—ã¾ã™)ã€‚

ãªãŠã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ç‰¹ã«è¨€åŠã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸãŒã€Access Token ã«ã‚‚ acr ã‚¯ãƒ¬ãƒ¼ãƒ ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‹ã‚‰ RFC 9470 OAuth 2.0 Step Up Authentication Challenge Protocol[^5] ã¿ãŸã„ãªã“ã¨ã‚‚ã§ããã†ãªé›°å›²æ°—ã‚’æ„Ÿã˜ã¾ã—ãŸã€‚

ã§ã¯ã¾ãŸï¼

[^1]: Step-up authentication using ACR values https://developer.okta.com/docs/guides/step-up-authentication/main/
[^2]: OpenID Connect Core 1.0 incorporating errata set 2 | https://openid.net/specs/openid-connect-core-1_0.html#acrSemantics
[^3]: OpenID Connect Extended Authentication Profile (EAP) ACR Values 1.0 - draft 00 https://openid.net/specs/openid-connect-eap-acr-values-1_0-ID1.html
[^4]: Authentication Method Reference Values | 2.  Authentication Method Reference Values https://www.rfc-editor.org/rfc/rfc8176.html#section-2
[^5]: OAuth 2.0 Step Up Authentication Challenge Protocol https://datatracker.ietf.org/doc/rfc9470/